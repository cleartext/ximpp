<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>XMPP.as</title>
<link rel="stylesheet" type="text/css" href="../../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptComment">/*
This file is part of seesmic-as3-xmpp.
Copyright (c)2009 Seesmic, Inc

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
*/</span>

<span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">seesmic</span>.<span class="ActionScriptDefault_Text">as3</span>.<span class="ActionScriptDefault_Text">xmpp</span>
<span class="ActionScriptBracket/Brace">{</span>

    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">seesmic</span>.<span class="ActionScriptDefault_Text">as3</span>.<span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">xep</span>.<span class="ActionScriptDefault_Text">Plugin</span>;
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">TimerEvent</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">Dictionary</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">Timer</span>;
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">mx</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">Base64Encoder</span>;
    
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">XMPP</span> <span class="ActionScriptReserved">extends</span> <span class="ActionScriptDefault_Text">XMLStream</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">password</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bound</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">authed</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">fulljid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">JID</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">original_jid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">JID</span>;
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">plugin</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Dictionary</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Dictionary</span><span class="ActionScriptBracket/Brace">()</span>;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">reconnect_timer</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Timer</span>; 
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">reconnect_index</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 0;
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">reconnect_times</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[</span>5,5,5,5,5,5,30,60<span class="ActionScriptBracket/Brace">]</span>;

        <span class="ActionScriptReserved">protected</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">host</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stanzaId</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">auto_reconnect</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">roster</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Roster</span>;
        
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ping_timer</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Timer</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Timer</span><span class="ActionScriptBracket/Brace">(</span>90000<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">pinged</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">session_start_timeout</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Timer</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Timer</span><span class="ActionScriptBracket/Brace">(</span>30000, 1<span class="ActionScriptBracket/Brace">)</span>;
        
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">XMPP</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span>, <span class="ActionScriptDefault_Text">password</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span>, <span class="ActionScriptDefault_Text">server</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">setJID</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">password</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">password</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">password</span>;
            <span class="ActionScriptComment">//trace(&apos;Connecting for &apos; + jid.toString() + &apos; on &apos; + server);
</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">server</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">setServer</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">server</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">rootStanzas</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;{jabber:client}iq&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span>  <span class="ActionScriptDefault_Text">IqStanza</span>;
            <span class="ActionScriptDefault_Text">rootStanzas</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;{jabber:client}message&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">MessageStanza</span>;
            <span class="ActionScriptDefault_Text">rootStanzas</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;{jabber:client}presence&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">PresenceStanza</span>;                
            <span class="ActionScriptDefault_Text">handlers</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XPathHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;{http://etherx.jabber.org/streams}features&quot;</span>, <span class="ActionScriptDefault_Text">StreamFeaturesHandler</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XPathHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&apos;{jabber:client}message/{jabber:client}body&apos;</span>, <span class="ActionScriptDefault_Text">handleMessage</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XPathHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;{urn:ietf:params:xml:ns:xmpp-sasl}success&quot;</span>, <span class="ActionScriptDefault_Text">authSuccessHandler</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XPathHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;{urn:ietf:params:xml:ns:xmpp-sasl}failure&quot;</span>, <span class="ActionScriptDefault_Text">authFailureHandler</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XPathHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;{jabber:client}presence&quot;</span>, <span class="ActionScriptDefault_Text">handlePresence</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XPathHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;{jabber:client}iq/{jabber:iq:roster}query&quot;</span>, <span class="ActionScriptDefault_Text">rosterHandler</span><span class="ActionScriptBracket/Brace">))</span>;            
            <span class="ActionScriptDefault_Text">ping_timer</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(T</span><span class="ActionScriptDefault_Text">imerEvent</span>.<span class="ActionScriptDefault_Text">TIMER</span>, <span class="ActionScriptDefault_Text">pingServer</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">session_start_timeout</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(T</span><span class="ActionScriptDefault_Text">imerEvent</span>.<span class="ActionScriptDefault_Text">TIMER</span>, <span class="ActionScriptDefault_Text">checkSessionTimeout</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">setJID</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XMPP</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;connected&apos;</span><span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">settingjid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">fulljid</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">settingjid</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;    
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptDefault_Text">fulljid</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">JID</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">settingjid</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">original_jid</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">fulljid</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptDefault_Text">host</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">fulljid</span>.<span class="ActionScriptDefault_Text">host</span>;
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">server</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">server</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">host</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">this</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">setServer</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">server</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XMPP</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">server</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">server</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">server</span>;
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">host</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">host</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">server</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">stream_start</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;&lt;stream:stream to=\&quot;&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">host</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;\&quot; xmlns:stream=&apos;http://etherx.jabber.org/streams&apos; xmlns=&apos;jabber:client&apos; version=&apos;1.0&apos;&gt;&quot;</span>;
            <span class="ActionScriptDefault_Text">stream_end</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;&lt;/stream:stream&gt;&quot;</span>;
            <span class="ActionScriptDefault_Text">setup</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">server</span>, 5222<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">socket</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">StreamEvent</span>.<span class="ActionScriptDefault_Text">DISCONNECTED</span>, <span class="ActionScriptDefault_Text">handleDisconnected</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">socket</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">StreamEvent</span>.<span class="ActionScriptDefault_Text">CONNECT_FAILED</span>, <span class="ActionScriptDefault_Text">handleConnectFailed</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">reset</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">this</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">connect</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">session_start_timeout</span>.<span class="ActionScriptDefault_Text">start</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">super</span>.<span class="ActionScriptDefault_Text">connect</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">setPassword</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">password</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XMPP</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">password</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">password</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">this</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">reset</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// reset the state
</span>            <span class="ActionScriptDefault_Text">stanzaId</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;authed&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;session&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;bound&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;encrypted&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;session_feature&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">roster</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Roster</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">socket</span>.<span class="ActionScriptDefault_Text">reset</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">checkSessionTimeout</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">TimerEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;session&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Session not established in 30 seconds, closing socket&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;connected&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptDefault_Text">tryReconnect</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">addPlugin</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pi</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Plugin</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">plugin</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">pi</span>.<span class="ActionScriptDefault_Text">shortcut</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">pi</span>
            <span class="ActionScriptDefault_Text">pi</span>.<span class="ActionScriptDefault_Text">setInstance</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Loading Plugin: &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">pi</span>.<span class="ActionScriptDefault_Text">name</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">pi</span>.<span class="ActionScriptDefault_Text">init</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">protected</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">handleDisconnected</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">StreamEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;connected&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">tryReconnect</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptASDoc">/** modified by astewart@cleartext.com */</span>
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">protected</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">handleConnectFailed</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">StreamEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;connected&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">tryReconnect</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptASDoc">/** modified by astewart@cleartext.com */</span>
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">tryReconnect</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">reset</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;connected&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">ping_timer</span>.<span class="ActionScriptDefault_Text">stop</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">auto_reconnect</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;disconnect_called&apos;</span><span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">reset</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">reconnect_index</span> <span class="ActionScriptOperator">=</span> 0;
                <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Waiting &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">reconnect_times</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">reconnect_index</span><span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; seconds to reconnect.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">reconnect_timer</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Timer</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">reconnect_times</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptReserved">this</span>.<span class="ActionScriptDefault_Text">reconnect_index</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">*</span> 1000, 1<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">fulljid</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">original_jid</span>;
                <span class="ActionScriptDefault_Text">reconnect_timer</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(T</span><span class="ActionScriptDefault_Text">imerEvent</span>.<span class="ActionScriptDefault_Text">TIMER</span>, <span class="ActionScriptDefault_Text">doReconnect</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">reconnect_timer</span>.<span class="ActionScriptDefault_Text">start</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">reconnect_index</span> <span class="ActionScriptOperator">+</span> 1 <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">reconnect_times</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">reconnect_index</span><span class="ActionScriptOperator">++</span>;     
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">doReconnect</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">TimerEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;connected&apos;</span><span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">reset</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">reconnect</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&apos;Tried to reconnect, but was already connected.&apos;</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">newId</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">stanzaId</span> <span class="ActionScriptOperator">+=</span> 1;
            <span class="ActionScriptComment">//return &quot;%X&quot; % String(stanzaId);
</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stanzaId</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">handleMessage</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">msg</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">MessageStanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">msg</span>.<span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptString">&apos;chat&apos;</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">msg</span>.<span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">msg</span>.<span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptString">&apos;normal&apos;</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">MESSAGE</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptDefault_Text">msg</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">msg</span>.<span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptString">&apos;groupchat&apos;</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">MESSAGE_MUC</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptDefault_Text">msg</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">handlePresence</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">presence</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">PresenceStanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">PRESENCE</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptDefault_Text">presence</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">cat</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">getCategory</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cat</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptString">&apos;available&apos;</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">roster</span>.<span class="ActionScriptDefault_Text">updatePresence</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">from</span>, <span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">type</span>, <span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">status</span>, <span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">priority</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">PRESENCE_AVAILABLE</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptDefault_Text">presence</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cat</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptString">&apos;unavailable&apos;</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">roster</span>.<span class="ActionScriptDefault_Text">updatePresence</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">from</span>, <span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">type</span>, <span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">status</span>, <span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">priority</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">PRESENCE_UNAVAILABLE</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptDefault_Text">presence</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cat</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptString">&apos;error&apos;</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">roster</span>.<span class="ActionScriptDefault_Text">updatePresence</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">from</span>, <span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">type</span>, <span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">status</span>, <span class="ActionScriptDefault_Text">presence</span>.<span class="ActionScriptDefault_Text">priority</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">PRESENCE_ERROR</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptDefault_Text">presence</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cat</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptString">&apos;subscribe&apos;</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">PRESENCE_SUBSCRIBE</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptDefault_Text">presence</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">StreamFeaturesHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Stanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&apos;got stream features&apos;</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">xmlobj</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">xml</span>.<span class="ActionScriptDefault_Text">getXML</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">use_tls</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;authed&apos;</span><span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;encrypted&apos;</span><span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">XPathMatch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xmlobj</span>, <span class="ActionScriptString">&apos;{http://etherx.jabber.org/streams}features/{urn:ietf:params:xml:ns:xmpp-tls}starttls&apos;</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XPathHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;{urn:ietf:params:xml:ns:xmpp-tls}proceed&quot;</span>, <span class="ActionScriptDefault_Text">TLSProceedHandler</span>, <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">))</span>;
                <span class="ActionScriptDefault_Text">socket</span>.<span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;&lt;starttls xmlns=&apos;urn:ietf:params:xml:ns:xmpp-tls&apos; /&gt;&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">fulljid</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">password</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;authed&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">MaskMatch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xmlobj</span>, <span class="ActionScriptString">&quot;&lt;features xmlns=&apos;http://etherx.jabber.org/streams&apos;&gt;&lt;mechanisms xmlns=&apos;urn:ietf:params:xml:ns:xmpp-sasl&apos;&gt;&lt;mechanism&gt;PLAIN&lt;/mechanism&gt;&lt;/mechanisms&gt;&lt;/features&gt;&quot;</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">encodedauth</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Base64Encoder</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Base64Encoder</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">encodedauth</span>.<span class="ActionScriptDefault_Text">encode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;\x00&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">fulljid</span>.<span class="ActionScriptDefault_Text">user</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;\x00&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">password</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;&lt;auth xmlns=&apos;urn:ietf:params:xml:ns:xmpp-sasl&apos; mechanism=&apos;PLAIN&apos;&gt;&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">encodedauth</span>.<span class="ActionScriptDefault_Text">toString</span><span class="ActionScriptBracket/Brace">()</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;&lt;/auth&gt;&quot;</span> <span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">((!</span><span class="ActionScriptDefault_Text">fulljid</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">password</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;authed&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">MaskMatch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xmlobj</span>, <span class="ActionScriptString">&quot;&lt;features xmlns=&apos;http://etherx.jabber.org/streams&apos;&gt;&lt;mechanisms xmlns=&apos;urn:ietf:params:xml:ns:xmpp-sasl&apos;&gt;&lt;mechanism&gt;ANONYMOUS&lt;/mechanism&gt;&lt;/mechanisms&gt;&lt;/features&gt;&quot;</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;&lt;auth xmlns=&apos;urn:ietf:params:xml:ns:xmpp-sasl&apos; mechanism=&apos;ANONYMOUS&apos; /&gt;&quot;</span> <span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;authed&apos;</span><span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;No authentication mechanism supported.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">disconnect</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;authed&apos;</span><span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;bound&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">XPathMatch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xmlobj</span>, <span class="ActionScriptString">&apos;{http://etherx.jabber.org/streams}features/{urn:ietf:params:xml:ns:xmpp-bind}bind&apos;</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">namespace</span> <span class="ActionScriptDefault_Text">xmpp_bind</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;urn:ietf:params:xml:ns:xmpp-bind&quot;</span>;
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">newId</span><span class="ActionScriptBracket/Brace">()</span>;
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">iq</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">iq</span> <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">=</span>&apos;<span class="ActionScriptReserved">set</span>&apos; <span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">=</span><span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptOperator">&gt;&lt;</span><span class="ActionScriptDefault_Text">bind</span> <span class="ActionScriptDefault_Text">xmlns</span><span class="ActionScriptOperator">=</span>&apos;<span class="ActionScriptDefault_Text">urn</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ietf</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">params</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ns</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">xmpp</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">bind</span>&apos; <span class="ActionScriptOperator">/&gt;&lt;/</span><span class="ActionScriptDefault_Text">iq</span><span class="ActionScriptOperator">&gt;</span>;
                    <span class="ActionScriptDefault_Text">iq</span>.@<span class="ActionScriptDefault_Text">id</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">id</span>;
                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">fulljid</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">resx</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">resource</span><span class="ActionScriptOperator">&gt;</span><span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptDefault_Text">fulljid</span>.<span class="ActionScriptDefault_Text">resource</span><span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptOperator">&lt;/</span><span class="ActionScriptDefault_Text">resource</span><span class="ActionScriptOperator">&gt;</span>;
                        <span class="ActionScriptDefault_Text">iq</span>.<span class="ActionScriptDefault_Text">xmpp_bind</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">bind</span>.<span class="ActionScriptDefault_Text">appendChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">resx</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">IdHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptBracket/Brace">)</span>, <span class="ActionScriptDefault_Text">bindResponseHandler</span><span class="ActionScriptBracket/Brace">))</span>;
                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XPathMatch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xmlobj</span>, <span class="ActionScriptString">&apos;{http://etherx.jabber.org/streams}features/{urn:ietf:params:xml:ns:xmpp-session}session&apos;</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;session_feature&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">iq</span>.<span class="ActionScriptDefault_Text">toXMLString</span><span class="ActionScriptBracket/Brace">())</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">bindResponseHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Stanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">namespace</span> <span class="ActionScriptDefault_Text">xmpp_bind</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;urn:ietf:params:xml:ns:xmpp-bind&quot;</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">xmlObj</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">xml</span>.<span class="ActionScriptDefault_Text">getXML</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&apos;binding to&apos;</span>, <span class="ActionScriptDefault_Text">xmlObj</span>.<span class="ActionScriptDefault_Text">xmpp_bind</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">bind</span>.<span class="ActionScriptDefault_Text">xmpp_bind</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">jid</span>.<span class="ActionScriptDefault_Text">text</span><span class="ActionScriptBracket/Brace">())</span>;
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">BOUND</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptDefault_Text">fulljid</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">JID</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xmlObj</span>.<span class="ActionScriptDefault_Text">xmpp_bind</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">bind</span>.<span class="ActionScriptDefault_Text">xmpp_bind</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">jid</span>.<span class="ActionScriptDefault_Text">text</span><span class="ActionScriptBracket/Brace">())</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;session_feature&apos;</span><span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">newId</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">IdHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptBracket/Brace">)</span>, <span class="ActionScriptDefault_Text">sessionResponseHandler</span><span class="ActionScriptBracket/Brace">))</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sessionrequest</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;&lt;iq type=&apos;set&apos; id=&apos;&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">id</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;&apos;&gt;&lt;session xmlns=&apos;urn:ietf:params:xml:ns:xmpp-session&apos; /&gt;&lt;/iq&gt;&quot;</span>;
                <span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sessionrequest</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sessionResponseHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Stanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>    
            <span class="ActionScriptDefault_Text">ping_timer</span>.<span class="ActionScriptDefault_Text">start</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;session&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">SESSION</span><span class="ActionScriptBracket/Brace">))</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">pingServer</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">TimerEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">pinged</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">ping_timer</span>.<span class="ActionScriptDefault_Text">stop</span><span class="ActionScriptBracket/Brace">()</span>
                <span class="ActionScriptDefault_Text">pinged</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>; <span class="ActionScriptComment">// reset it so that it doesn&apos;t error next time
</span>                <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;connected&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptDefault_Text">tryReconnect</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">return</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">pinged</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">newId</span><span class="ActionScriptBracket/Brace">()</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">pingxml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">iq</span> <span class="ActionScriptReserved">to</span><span class="ActionScriptOperator">=</span><span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptDefault_Text">host</span><span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">=</span><span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&apos;get&apos;</span><span class="ActionScriptOperator">&gt;&lt;</span><span class="ActionScriptDefault_Text">ping</span> <span class="ActionScriptDefault_Text">xmlns</span><span class="ActionScriptOperator">=</span>&apos;<span class="ActionScriptDefault_Text">urn</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">xmpp</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ping</span>&apos;<span class="ActionScriptOperator">/&gt;&lt;/</span><span class="ActionScriptDefault_Text">iq</span><span class="ActionScriptOperator">&gt;</span>;
            <span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">IdHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptBracket/Brace">)</span>, <span class="ActionScriptDefault_Text">pingResponseHandler</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pingxml</span>.<span class="ActionScriptDefault_Text">toXMLString</span><span class="ActionScriptBracket/Brace">())</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">pingResponseHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Stanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&apos;got ping&apos;</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">pinged</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">TLSProceedHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Stanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//socket.addEventListener(StreamEvent.TLS_READY, startTLSStream);
</span>            <span class="ActionScriptDefault_Text">startTLS</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">host</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;encrypted&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stream_start</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">SECURE</span><span class="ActionScriptBracket/Brace">))</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">authSuccessHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Stanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">AUTH_SUCCEEDED</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;authed&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stream_start</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">socket</span>.<span class="ActionScriptDefault_Text">reset</span><span class="ActionScriptBracket/Brace">()</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">authFailureHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Stanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">state</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&apos;auth_failed&apos;</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">AUTH_FAILED</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptDefault_Text">disconnect</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendMessage</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tojid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">msg</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">subject</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span>, <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&apos;chat&apos;</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">nmsg</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">MessageStanza</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">MessageStanza</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">nmsg</span>.<span class="ActionScriptDefault_Text">setTo</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tojid</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">nmsg</span>.<span class="ActionScriptDefault_Text">setFrom</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">fulljid</span>.<span class="ActionScriptDefault_Text">toString</span><span class="ActionScriptBracket/Brace">())</span>;
            <span class="ActionScriptDefault_Text">nmsg</span>.<span class="ActionScriptDefault_Text">setBody</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">msg</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">nmsg</span>.<span class="ActionScriptDefault_Text">setType</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">nmsg</span>.<span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptComment">//send(&quot;&lt;message type=&apos;&quot; + type + &quot;&apos; from=&apos;&quot; + fulljid.toString() + &quot;&apos; to=&apos;&quot; + tojid + &quot;&apos;&gt;&lt;body&gt;&quot; + msg + &quot;&lt;/body&gt;&lt;/message&gt;&quot;);
</span>        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendPresence</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">status</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span>,<span class="ActionScriptDefault_Text">show</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span>,<span class="ActionScriptDefault_Text">priority</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span>,<span class="ActionScriptDefault_Text">tojid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span>,<span class="ActionScriptDefault_Text">avatarHash</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">npres</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">PresenceStanza</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">PresenceStanza</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tojid</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">npres</span>.<span class="ActionScriptDefault_Text">setTo</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tojid</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">status</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">npres</span>.<span class="ActionScriptDefault_Text">setStatus</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">status</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">show</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">npres</span>.<span class="ActionScriptDefault_Text">setType</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">show</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">priority</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">npres</span>.<span class="ActionScriptDefault_Text">setPriority</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">priority</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptASDoc">/**
             * PresenceStanza.avatarHash added by astewart@cleartext.com
             */</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">avatarHash</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">npres</span>.<span class="ActionScriptDefault_Text">setAvatarHash</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">avatarHash</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">npres</span>.<span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getRoster</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">iqs</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IqStanza</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">IqStanza</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">//iqs.setTo(host);
</span>            <span class="ActionScriptDefault_Text">iqs</span>.<span class="ActionScriptDefault_Text">setType</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&apos;get&apos;</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">queryx</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">query</span> <span class="ActionScriptDefault_Text">xmlns</span><span class="ActionScriptOperator">=</span>&apos;<span class="ActionScriptDefault_Text">jabber</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">iq</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">roster</span>&apos; <span class="ActionScriptOperator">/&gt;</span>;
            <span class="ActionScriptDefault_Text">iqs</span>.<span class="ActionScriptDefault_Text">setQuery</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">queryx</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">iqs</span>.<span class="ActionScriptDefault_Text">setID</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptComment">//addHandler(new IdHandler(id, rosterHandler));
</span>            <span class="ActionScriptDefault_Text">iqs</span>.<span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">rosterHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Stanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">namespace</span> <span class="ActionScriptDefault_Text">rosterns</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;jabber:iq:roster&quot;</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">getXML</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xml</span>.@<span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptString">&apos;error&apos;</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">groups</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">result</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Dictionary</span>;
                <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">item</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">xml</span>.<span class="ActionScriptDefault_Text">rosterns</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">query</span>.<span class="ActionScriptDefault_Text">rosterns</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">item</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">groups</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">()</span>;
                    <span class="ActionScriptComment">// old: for each(var group:XML in item.group) {
</span>                    <span class="ActionScriptComment">// edited by astewart@cleartext.com
</span>                    <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">group</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">item</span>.<span class="ActionScriptDefault_Text">rosterns</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">group</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">groups</span>.<span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">group</span>.<span class="ActionScriptDefault_Text">text</span><span class="ActionScriptBracket/Brace">())</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">JID</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">JID</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">item</span>.@<span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptDefault_Text">result</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">roster</span>.<span class="ActionScriptDefault_Text">updateItem</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span>, <span class="ActionScriptDefault_Text">item</span>.@<span class="ActionScriptDefault_Text">subscription</span>, <span class="ActionScriptDefault_Text">item</span>.@<span class="ActionScriptDefault_Text">name</span>, <span class="ActionScriptDefault_Text">groups</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">ROSTER_ITEM</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptDefault_Text">result</span><span class="ActionScriptBracket/Brace">))</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">ROSTER_ERROR</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptReserved">false</span>, <span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">override</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getInstance</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span> <span class="ActionScriptBracket/Brace">{</span>  <span class="ActionScriptComment">// I need the real instance, so override this (gross, I&apos;m not used to single inheritance/strict type)
</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">this</span>;
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">disconnect</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">super</span>.<span class="ActionScriptDefault_Text">disconnect</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">ping_timer</span>.<span class="ActionScriptDefault_Text">stop</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>

    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>

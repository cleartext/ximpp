<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>DatabaseModel.as</title>
<link rel="stylesheet" type="text/css" href="../../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>
<span class="ActionScriptBracket/Brace">{</span>
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">valueObjects</span>.<span class="ActionScriptDefault_Text">Buddy</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">valueObjects</span>.<span class="ActionScriptDefault_Text">DatabaseValue</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">valueObjects</span>.<span class="ActionScriptDefault_Text">GlobalSettings</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">valueObjects</span>.<span class="ActionScriptDefault_Text">Message</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">valueObjects</span>.<span class="ActionScriptDefault_Text">UserAccount</span>;
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">SQLConnection</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">SQLMode</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">SQLResult</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">SQLStatement</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">Event</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">EventDispatcher</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">SQLErrorEvent</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">SQLEvent</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">filesystem</span>.<span class="ActionScriptDefault_Text">File</span>;
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">mx</span>.<span class="ActionScriptDefault_Text">collections</span>.<span class="ActionScriptDefault_Text">ArrayCollection</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">mx</span>.<span class="ActionScriptDefault_Text">managers</span>.<span class="ActionScriptDefault_Text">CursorManager</span>;
    
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">DatabaseModel</span> <span class="ActionScriptReserved">extends</span> <span class="ActionScriptDefault_Text">EventDispatcher</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptComment">/*
         * synchronous and asynchronous database connections
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">syncConn</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLConnection</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">asyncConn</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLConnection</span>;
        
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">Autowire</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">appModel</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ApplicationModel</span>; 
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">settings</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SettingsModel</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">settings</span>;
        <span class="ActionScriptBracket/Brace">}</span>
                
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">close</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Closing async database connection&quot;</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptDefault_Text">asyncConn</span>.<span class="ActionScriptDefault_Text">close</span><span class="ActionScriptBracket/Brace">()</span>;

            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Closing sync database connection&quot;</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">close</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * create the database file and make sure the appropriate tables exist
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">createDatabase</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">try</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Creating and opening database&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptComment">// create the local database file
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dbName</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;ximpp.db&quot;</span>;
                <span class="ActionScriptComment">//dbName = new Date().time + &quot;.db&quot;;
</span>                
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dbFile</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">File</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">File</span>.<span class="ActionScriptDefault_Text">applicationStorageDirectory</span>.<span class="ActionScriptDefault_Text">resolvePath</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dbName</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;DB Location: &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">dbFile</span>.<span class="ActionScriptDefault_Text">nativePath</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Openning async database connection&quot;</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">asyncConn</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLConnection</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">asyncConn</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">SQLErrorEvent</span>.<span class="ActionScriptDefault_Text">ERROR</span>, <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span>, <span class="ActionScriptReserved">false</span>, 0, <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">asyncConn</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">SQLEvent</span>.<span class="ActionScriptDefault_Text">OPEN</span>, <span class="ActionScriptDefault_Text">createTables</span>, <span class="ActionScriptReserved">false</span>, 0, <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">asyncConn</span>.<span class="ActionScriptDefault_Text">openAsync</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dbFile</span><span class="ActionScriptBracket/Brace">)</span>;

                <span class="ActionScriptComment">// link the sync connection to the file
</span>                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Opening sync database connection&quot;</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">syncConn</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLConnection</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">open</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dbFile</span>, <span class="ActionScriptDefault_Text">SQLMode</span>.<span class="ActionScriptDefault_Text">UPDATE</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">SQLErrorEvent</span>.<span class="ActionScriptDefault_Text">ERROR</span>, <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span>, <span class="ActionScriptReserved">false</span>, 0, <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">catch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">error</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">error</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">fatalError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Could not create local database file.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>            
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">createTables</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">try</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// start a transaction
</span>                <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
                
                <span class="ActionScriptComment">/*
                 * create the global settings table
                 */</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Creating global settings table.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">GlobalSettings</span>.<span class="ActionScriptDefault_Text">CREATE_GLOBAL_SETTINGS_TABLE</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;

                <span class="ActionScriptComment">/*
                 * check there is at least one row in the global settings table
                 */</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Checking default global settings exist.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;INSERT INTO globalSettings (settingId)&quot;</span> <span class="ActionScriptOperator">+</span> 
                    <span class="ActionScriptString">&quot;SELECT 1 &quot;</span> <span class="ActionScriptOperator">+</span> 
                    <span class="ActionScriptString">&quot;WHERE NOT EXISTS (SELECT 1 FROM globalSettings WHERE settingId=1)&quot;</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;

                <span class="ActionScriptComment">/*
                 * create the user accounts table
                 */</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Creating user settings table.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">UserAccount</span>.<span class="ActionScriptDefault_Text">CREATE_USER_ACCOUNTS_TABLE</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
                
                <span class="ActionScriptComment">/*
                 * check there is at least one user account
                 */</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Checking user account exist.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;INSERT INTO userAccounts (userId)&quot;</span> <span class="ActionScriptOperator">+</span> 
                    <span class="ActionScriptString">&quot;SELECT 1 &quot;</span> <span class="ActionScriptOperator">+</span> 
                    <span class="ActionScriptString">&quot;WHERE NOT EXISTS (SELECT 1 FROM userAccounts WHERE userId=1)&quot;</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;

                <span class="ActionScriptComment">/*
                 * create the messages table
                 */</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Creating messages table&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Message</span>.<span class="ActionScriptDefault_Text">CREATE_MESSAGES_TABLE</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
                
                <span class="ActionScriptComment">/*
                 * Create entitites table
                 */</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Creating buddy table&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Buddy</span>.<span class="ActionScriptDefault_Text">CREATE_BUDDIES_TABLE</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
                
                <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Database created&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Event</span>.<span class="ActionScriptDefault_Text">COMPLETE</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">catch</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">error</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">error</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">fatalError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Could not create database tables.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptASDoc">/**
         * Load user settings
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">loadUserSettings</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">newUserId</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// start a transaction 
</span>            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Loading user settings&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;SELECT * FROM userAccounts WHERE userId=&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">newUserId</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
            
               <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">result</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLResult</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">getResult</span><span class="ActionScriptBracket/Brace">()</span>;

            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// if we&apos;ve got to this point without errors, commit the transaction 
</span>                <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;User settings loaded &quot;</span><span class="ActionScriptBracket/Brace">)</span>;

                <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">UserAccount</span>.<span class="ActionScriptDefault_Text">createFromDB</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">UserAccount</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">else</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">fatalError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;no user account with id: &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">newUserId</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * Load global settings
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">loadGlobalSettings</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// start a transaction 
</span>            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Loading global settings&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;SELECT * FROM globalSettings&quot;</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
            
               <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">result</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLResult</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">getResult</span><span class="ActionScriptBracket/Brace">()</span>;
               
               <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">newUserId</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">newUserId</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">][</span><span class="ActionScriptString">&quot;userId&quot;</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">global</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">GlobalSettings</span>.<span class="ActionScriptDefault_Text">createFromDB</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">GlobalSettings</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// if we&apos;ve got to this point without errors, commit the transaction 
</span>            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Global settings loaded&quot;</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptComment">// if the userId has changed, then we want to get all data from the database
</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">newUserId</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userId</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">loadUserSettings</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">newUserId</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">loadBuddyData</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">try</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>; 
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Loading buddy list&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;Select * from buddies WHERE userid=&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userId</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; ORDER BY lastSeen ASC&quot;</span> ;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>; 
                
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">result</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLResult</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">getResult</span><span class="ActionScriptBracket/Brace">()</span>;
                
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">-</span>1; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&gt;=</span>0; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">--</span><span class="ActionScriptBracket/Brace">)</span>
                        <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">addBuddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Buddy</span>.<span class="ActionScriptDefault_Text">createFromDB</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">])</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">Buddy</span><span class="ActionScriptBracket/Brace">)</span>;

                <span class="ActionScriptComment">// if we&apos;ve got to this point without errors, commit the transaction 
</span>                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Buddy list loaded&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">catch</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
                
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">loadTimelineData</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>            
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Loading message data&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;Select * from messages WHERE userid=&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userId</span>
                <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; ORDER BY timestamp DESC LIMIT 0,&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">global</span>.<span class="ActionScriptDefault_Text">numTimelineMessages</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>; 
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">result</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLResult</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">getResult</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">timeLineMessages</span>.<span class="ActionScriptDefault_Text">removeAll</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">length</span>;
                <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">=</span>0; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">len</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">timeLineMessages</span>.<span class="ActionScriptDefault_Text">addItem</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Message</span>.<span class="ActionScriptDefault_Text">createFromDB</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]))</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// if we&apos;ve got to this point without errors, commit the transaction 
</span>            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Message data loaded&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getAllUserAccounts</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ArrayCollection</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// start a transaction 
</span>            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Loading user accounts&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;SELECT * FROM userAccounts&quot;</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
            
               <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">result</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLResult</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">getResult</span><span class="ActionScriptBracket/Brace">()</span>;
               <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">accounts</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ArrayCollection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ArrayCollection</span><span class="ActionScriptBracket/Brace">()</span>;

            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">length</span>;
                <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">=</span>0; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">len</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">accounts</span>.<span class="ActionScriptDefault_Text">addItem</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">UserAccount</span>.<span class="ActionScriptDefault_Text">createFromDB</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]))</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// if we&apos;ve got to this point without errors, commit the transaction 
</span>            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;User accounts loaded&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">accounts</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">removeAccount</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">userId</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Deleting user account with userId: &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">userId</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;DELETE FROM userAccounts WHERE userId = &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">userId</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;

            <span class="ActionScriptComment">// if we&apos;ve got to this point without errors, commit the transaction 
</span>            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;User account deleted&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">saveGlobalSettings</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Saving global settings.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">values</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">global</span>.<span class="ActionScriptDefault_Text">toDatabaseValues</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userId</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">DatabaseValue</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;settingId&quot;</span>, 1<span class="ActionScriptBracket/Brace">)]</span>;
            
            <span class="ActionScriptDefault_Text">updateStmt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;globalSettings&quot;</span>, <span class="ActionScriptDefault_Text">values</span>, <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">saveUserAccount</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">userAccount</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">UserAccount</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Saving user account &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">accountName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; userId: &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">userId</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">values</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">toDatabaseValues</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">userId</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">DatabaseValue</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;userId&quot;</span>, <span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">userId</span><span class="ActionScriptBracket/Brace">)]</span>
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">result</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">updateOrInsert</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;userAccounts&quot;</span>, <span class="ActionScriptDefault_Text">values</span>, <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">userId</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">result</span>;
            
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">result</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">saveBuddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Buddy</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">DatabaseValue</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;jid&quot;</span>, <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)]</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">updateOrInsert</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;buddies&quot;</span>, <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">toDatabaseValues</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userId</span><span class="ActionScriptBracket/Brace">)</span>, <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">id</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">setBuddyId</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">id</span>;
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">removeBuddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddyId</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Deleting buddy with buddyId: &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">buddyId</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;DELETE FROM buddies WHERE buddyId = &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">buddyId</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;

            <span class="ActionScriptComment">// if we&apos;ve got to this point without errors, commit the transaction 
</span>            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Buddy deleted&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">saveMessage</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">message</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Message</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">message</span>.<span class="ActionScriptDefault_Text">messageId</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">insertStmt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;messages&quot;</span>, <span class="ActionScriptDefault_Text">message</span>.<span class="ActionScriptDefault_Text">toDatabaseValues</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userId</span><span class="ActionScriptBracket/Brace">))</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">loadMessages</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Buddy</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ArrayCollection</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// start a transaction 
</span>            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Loading messages with &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;Select * from messages WHERE userid=&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userId</span>
                <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; AND (sender=&apos;&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">jid</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;&apos;&quot;</span>
                <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; OR recipient=&apos;&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">jid</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;&apos;)&quot;</span>
                <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; ORDER BY timestamp DESC &quot;</span>
                <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;LIMIT 0,&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">global</span>.<span class="ActionScriptDefault_Text">numChatMessages</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">result</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLResult</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">getResult</span><span class="ActionScriptBracket/Brace">()</span>;

            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">messages</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ArrayCollection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ArrayCollection</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">length</span>;
                <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">=</span>0; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">len</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">messages</span>.<span class="ActionScriptDefault_Text">addItem</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Message</span>.<span class="ActionScriptDefault_Text">createFromDB</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]))</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// if we&apos;ve got to this point without errors, commit the transaction 
</span>            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Messages loaded&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">messages</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">insertStmt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">table</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">values</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sql</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;INSERT INTO &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; (&quot;</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">valuesString</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;) VALUES (&quot;</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">firstTime</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">value</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">DatabaseValue</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">values</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">firstTime</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">firstTime</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptReserved">else</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptString">&quot;, &quot;</span>;
                    <span class="ActionScriptDefault_Text">valuesString</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptString">&quot;, &quot;</span>;
                <span class="ActionScriptBracket/Brace">}</span>

                <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">value</span>.<span class="ActionScriptDefault_Text">columnName</span>;
                <span class="ActionScriptDefault_Text">valuesString</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">value</span>.<span class="ActionScriptDefault_Text">param</span>;
                <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">parameters</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">value</span>.<span class="ActionScriptDefault_Text">param</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">value</span>.<span class="ActionScriptDefault_Text">value</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">valuesString</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;)&quot;</span>;
    
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">sql</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">getResult</span><span class="ActionScriptBracket/Brace">()</span>.<span class="ActionScriptDefault_Text">lastInsertRowID</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">updateStmt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">table</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">values</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">values</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">return</span>;
            
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sql</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;UPDATE &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; SET &quot;</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">firstTime</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">v</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">DatabaseValue</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">values</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">firstTime</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">firstTime</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptReserved">else</span>
                    <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptString">&quot;, &quot;</span>;
                
                <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">v</span>.<span class="ActionScriptDefault_Text">setParameter</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">firstTime</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">DatabaseValue</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">firstTime</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptString">&quot; WHERE &quot;</span>;
                    <span class="ActionScriptDefault_Text">firstTime</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">else</span>
                    <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptString">&quot; AND &quot;</span>;

                <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">c</span>.<span class="ActionScriptDefault_Text">setParameter</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">sql</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">updateOrInsert</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">table</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">values</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">begin</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLStatement</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SQLStatement</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">sqlConnection</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">syncConn</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sql</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;SELECT * FROM &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span>;

            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">firstTime</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">DatabaseValue</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">firstTime</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptString">&quot; WHERE &quot;</span>;
                    <span class="ActionScriptDefault_Text">firstTime</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">else</span>
                    <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptString">&quot; AND &quot;</span>;

                <span class="ActionScriptDefault_Text">sql</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">c</span>.<span class="ActionScriptDefault_Text">setParameter</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stmt</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">text</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">sql</span>;
            <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">execute</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">result</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SQLResult</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stmt</span>.<span class="ActionScriptDefault_Text">getResult</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">syncConn</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">result</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">result</span>.<span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">updateStmt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">table</span>, <span class="ActionScriptDefault_Text">values</span>, <span class="ActionScriptDefault_Text">criteria</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptOperator">-</span>1;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">else</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">insertStmt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">table</span>, <span class="ActionScriptDefault_Text">values</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
    
<span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>

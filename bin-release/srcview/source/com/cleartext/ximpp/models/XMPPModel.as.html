<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>XMPPModel.as</title>
<link rel="stylesheet" type="text/css" href="../../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>
<span class="ActionScriptBracket/Brace">{</span>
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">PopUpEvent</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">types</span>.<span class="ActionScriptDefault_Text">IQTypes</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">types</span>.<span class="ActionScriptDefault_Text">SubscriptionTypes</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">valueObjects</span>.<span class="ActionScriptDefault_Text">Buddy</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">valueObjects</span>.<span class="ActionScriptDefault_Text">Chat</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">valueObjects</span>.<span class="ActionScriptDefault_Text">Message</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">valueObjects</span>.<span class="ActionScriptDefault_Text">Status</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">cleartext</span>.<span class="ActionScriptDefault_Text">ximpp</span>.<span class="ActionScriptDefault_Text">models</span>.<span class="ActionScriptDefault_Text">valueObjects</span>.<span class="ActionScriptDefault_Text">UserAccount</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">crypto</span>.<span class="ActionScriptDefault_Text">tls</span>.<span class="ActionScriptDefault_Text">TLSConfig</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">crypto</span>.<span class="ActionScriptDefault_Text">tls</span>.<span class="ActionScriptDefault_Text">TLSEngine</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">crypto</span>.<span class="ActionScriptDefault_Text">tls</span>.<span class="ActionScriptDefault_Text">TLSEvent</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">crypto</span>.<span class="ActionScriptDefault_Text">tls</span>.<span class="ActionScriptDefault_Text">TLSSocket</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">seesmic</span>.<span class="ActionScriptDefault_Text">as3</span>.<span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">IdHandler</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">seesmic</span>.<span class="ActionScriptDefault_Text">as3</span>.<span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">IqStanza</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">seesmic</span>.<span class="ActionScriptDefault_Text">as3</span>.<span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">PresenceStanza</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">seesmic</span>.<span class="ActionScriptDefault_Text">as3</span>.<span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">StreamEvent</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">seesmic</span>.<span class="ActionScriptDefault_Text">as3</span>.<span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">XMPP</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">seesmic</span>.<span class="ActionScriptDefault_Text">as3</span>.<span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">XMPPEvent</span>;
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">swizframework</span>.<span class="ActionScriptDefault_Text">Swiz</span>;
    
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">XMPPModel</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">Autowire</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&quot;appModel&quot;</span><span class="ActionScriptBracket/Brace">)]</span>
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">appModel</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ApplicationModel</span>;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">settings</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">SettingsModel</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">settings</span>;
        <span class="ActionScriptBracket/Brace">}</span>
            
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">database</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">DatabaseModel</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">database</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">connected</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;

        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">gotAvatar</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">gotRosterList</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">xmpp</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XMPP</span>;
                
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// CONSTRUCTOR
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">XMPPModel</span><span class="ActionScriptBracket/Brace">()</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">xmpp</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XMPP</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptComment">// event listeners for starting session (this is the order in which
</span>            <span class="ActionScriptComment">// the events are dispatched
</span>            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">StreamEvent</span>.<span class="ActionScriptDefault_Text">CONNECTED</span>, <span class="ActionScriptDefault_Text">logHandler</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">SECURE</span>, <span class="ActionScriptDefault_Text">logHandler</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">AUTH_SUCCEEDED</span>, <span class="ActionScriptDefault_Text">logHandler</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">SESSION</span>, <span class="ActionScriptDefault_Text">sessionHandler</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptComment">// fail handlers
</span>            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">StreamEvent</span>.<span class="ActionScriptDefault_Text">CONNECT_FAILED</span>, <span class="ActionScriptDefault_Text">failHandler</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">AUTH_FAILED</span>, <span class="ActionScriptDefault_Text">failHandler</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">StreamEvent</span>.<span class="ActionScriptDefault_Text">DISCONNECTED</span>, <span class="ActionScriptDefault_Text">failHandler</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptComment">// event listeners for messages, presance and changes to the roster
</span>            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">MESSAGE</span>, <span class="ActionScriptDefault_Text">messageHandler</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">PRESENCE</span>, <span class="ActionScriptDefault_Text">presenceHandler</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">XMPPEvent</span>.<span class="ActionScriptDefault_Text">ROSTER_ITEM</span>, <span class="ActionScriptDefault_Text">rosterListChangeHandler</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// CONNECT
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">connect</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">connected</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">serverSideStatus</span>.<span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">Status</span>.<span class="ActionScriptDefault_Text">CONNECTING</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">return</span>;

            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">account</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">UserAccount</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">account</span>.<span class="ActionScriptDefault_Text">jid</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">account</span>.<span class="ActionScriptDefault_Text">password</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">gotAvatar</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">auto_reconnect</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">serverSideStatus</span>.<span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Status</span>.<span class="ActionScriptDefault_Text">CONNECTING</span>;

                <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">setJID</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">account</span>.<span class="ActionScriptDefault_Text">jid</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;/cleartext&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">setPassword</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">account</span>.<span class="ActionScriptDefault_Text">password</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">setServer</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">account</span>.<span class="ActionScriptDefault_Text">server</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">setupTLS</span><span class="ActionScriptBracket/Brace">(T</span><span class="ActionScriptDefault_Text">LSEvent</span>, <span class="ActionScriptDefault_Text">TLSConfig</span>, <span class="ActionScriptDefault_Text">TLSEngine</span>, <span class="ActionScriptDefault_Text">TLSSocket</span>, <span class="ActionScriptReserved">true</span>, <span class="ActionScriptReserved">true</span>, <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">connect</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// DISCONNECT
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">disconnect</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">connected</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">connected</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                 <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Disconnecting from XMPP server&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;&lt;presence from=&apos;&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">fulljid</span>.<span class="ActionScriptDefault_Text">toString</span><span class="ActionScriptBracket/Brace">()</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;&apos; type=&apos;unavailable&apos; status=&apos;Logged out&apos; /&gt;&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                 <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">disconnect</span><span class="ActionScriptBracket/Brace">()</span>;
             <span class="ActionScriptBracket/Brace">}</span>
             
            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">auto_reconnect</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;

             <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">serverSideStatus</span>.<span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">=</span> 
                 <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">localStatus</span>.<span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">Status</span>.<span class="ActionScriptDefault_Text">OFFLINE</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">?</span> 
                 <span class="ActionScriptDefault_Text">Status</span>.<span class="ActionScriptDefault_Text">OFFLINE</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">Status</span>.<span class="ActionScriptDefault_Text">ERROR</span>;

             <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Buddy</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">rosterItems</span><span class="ActionScriptBracket/Brace">)</span>
                 <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">status</span>.<span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Status</span>.<span class="ActionScriptDefault_Text">OFFLINE</span>;
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// SESSION HANDLER
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptASDoc">/**
         * We have sucessfully initiated a session, now we can
         * say the server knows our status and we can get the
         * list of buddies and send our presence.
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sessionHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">serverSideStatus</span>.<span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">localStatus</span>.<span class="ActionScriptDefault_Text">value</span>;
            <span class="ActionScriptDefault_Text">connected</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;

            <span class="ActionScriptComment">// get the roster list
</span>            <span class="ActionScriptDefault_Text">gotRosterList</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">sendIq</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">jid</span>,
                    <span class="ActionScriptDefault_Text">IQTypes</span>.<span class="ActionScriptDefault_Text">GET</span>,
                    <span class="ActionScriptDefault_Text">IQTypes</span>.<span class="ActionScriptDefault_Text">GET_ROSTER</span>,
                    <span class="ActionScriptDefault_Text">getRosterHandler</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptComment">// get the vCard stored on the server
</span>            <span class="ActionScriptDefault_Text">getVCard</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptDefault_Text">sendPresence</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// LOG HANDLER
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">logHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// FAIL HANDLER
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">failHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">connected</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">disconnect</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// MESSAGE HANDLER
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptASDoc">/**
         * receive a message stanza, find the associated sender and
         * receiver buddies, save to the database and add to the correct
         * chat or timeline
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">messageHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">message</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Message</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Message</span>.<span class="ActionScriptDefault_Text">createFromStanza</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">database</span>.<span class="ActionScriptDefault_Text">saveMessage</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">message</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Buddy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">getBuddyByJid</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">message</span>.<span class="ActionScriptDefault_Text">sender</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">buddy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Buddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">message</span>.<span class="ActionScriptDefault_Text">sender</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">addBuddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">setLastSeen</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">message</span>.<span class="ActionScriptDefault_Text">timestamp</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">resource</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">from</span>.<span class="ActionScriptDefault_Text">resource</span>;
            
            <span class="ActionScriptDefault_Text">database</span>.<span class="ActionScriptDefault_Text">saveBuddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">chat</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Chat</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">getChat</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddy</span>, <span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">chat</span>.<span class="ActionScriptDefault_Text">messages</span>.<span class="ActionScriptDefault_Text">addItemAt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">message</span>,0<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// PRESENCE HANDLER
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">presenceHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">PresenceStanza</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">stanza</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">PresenceStanza</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">fromJid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">from</span>.<span class="ActionScriptDefault_Text">getBareJID</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">fromJid</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">return</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// note this is just for type &quot;subscribe&quot; - &quot;unsubscribed&quot; and
</span>            <span class="ActionScriptComment">// &quot;subscribed&quot; are handled below
</span>            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">SubscriptionTypes</span>.<span class="ActionScriptDefault_Text">SUBSCRIBE</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">Swiz</span>.<span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">PopUpEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">PopUpEvent</span>.<span class="ActionScriptDefault_Text">SUBSCRIPTION_REQUEST_WINDOW</span>, <span class="ActionScriptDefault_Text">fromJid</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">else</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Buddy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">getBuddyByJid</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">fromJid</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Received presence of type &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; from &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">fromJid</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; but buddy does not exist.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;    
                    <span class="ActionScriptReserved">return</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                
                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">resource</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">from</span>.<span class="ActionScriptDefault_Text">resource</span>;
                <span class="ActionScriptComment">// setFromStanzaType also handles &quot;unsubscribe&quot; and &quot;subscribed&quot;
</span>                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">status</span>.<span class="ActionScriptDefault_Text">setFromStanzaType</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">type</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">setCustomStatus</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">status</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">avatarHash</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">avatarHash</span>;
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">avatarHash</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">avatarHash</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">avatarHash</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">tempAvatarHash</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">avatarHash</span>;
                    <span class="ActionScriptDefault_Text">sendIq</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">jid</span>, <span class="ActionScriptString">&apos;get&apos;</span>, <span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">vCard</span> <span class="ActionScriptDefault_Text">xmlns</span><span class="ActionScriptOperator">=</span>&apos;<span class="ActionScriptDefault_Text">vcard</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">temp</span>&apos;<span class="ActionScriptOperator">/&gt;</span>, <span class="ActionScriptDefault_Text">vCardHandler</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptBracket/Brace">}</span>

                <span class="ActionScriptDefault_Text">database</span>.<span class="ActionScriptDefault_Text">saveBuddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// ROSTER CHANGED HANDLER
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">rosterListChangeHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XMPPEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">connected</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">gotRosterList</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">return</span>;
            
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;rosterListChangedHandler&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&quot;jid&quot;</span><span class="ActionScriptBracket/Brace">]</span>;

            <span class="ActionScriptComment">// if we already have the buddy, then we just want to
</span>            <span class="ActionScriptComment">// update the values, otherwise create a new buddy
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Buddy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">getBuddyByJid</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">buddy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Buddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">subscription</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&quot;subscription&quot;</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">subscription</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">SubscriptionTypes</span>.<span class="ActionScriptDefault_Text">REMOVE</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">removeBuddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">else</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">groups</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&quot;groups&quot;</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">setNickName</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptString">&quot;name&quot;</span><span class="ActionScriptBracket/Brace">])</span>;
                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">subscription</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">subscription</span>;
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">addBuddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// GET ROSTER HANDLER
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getRosterHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IqStanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;getRosterHandler&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">b1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Buddy</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">rosterItems</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">b1</span>.<span class="ActionScriptDefault_Text">used</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;

            <span class="ActionScriptReserved">namespace</span> <span class="ActionScriptDefault_Text">rosterns</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;jabber:iq:roster&quot;</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">item</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">query</span>.<span class="ActionScriptDefault_Text">rosterns</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">item</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">item</span>.@<span class="ActionScriptDefault_Text">jid</span>;
                
                <span class="ActionScriptComment">// if we already have the buddy, then we just want to
</span>                <span class="ActionScriptComment">// update the values, otherwise create a new buddy
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Buddy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">getBuddyByJid</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">buddy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Buddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">groups</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">group</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">item</span>.<span class="ActionScriptDefault_Text">rosterns</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">group</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">groups</span>.<span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">group</span>.<span class="ActionScriptDefault_Text">text</span><span class="ActionScriptBracket/Brace">())</span>;
                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">groups</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">groups</span>;
                
                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">setNickName</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">item</span>.@<span class="ActionScriptDefault_Text">name</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">subscription</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">item</span>.@<span class="ActionScriptDefault_Text">subscription</span>;
                
                <span class="ActionScriptComment">// flag used to delete buddies that are no longer in
</span>                <span class="ActionScriptComment">// the roster list
</span>                <span class="ActionScriptDefault_Text">buddy</span>.<span class="ActionScriptDefault_Text">used</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
                
                <span class="ActionScriptComment">// this adds, saves and adds an event listener to the buddy
</span>                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">addBuddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">b2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Buddy</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">rosterItems</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(!</span><span class="ActionScriptDefault_Text">b2</span>.<span class="ActionScriptDefault_Text">used</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">removeBuddy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b2</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptDefault_Text">gotRosterList</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// GET VCARD
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getVCard</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">sendIq</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">jid</span>,
                    <span class="ActionScriptDefault_Text">IQTypes</span>.<span class="ActionScriptDefault_Text">GET</span>,
                    <span class="ActionScriptDefault_Text">IQTypes</span>.<span class="ActionScriptDefault_Text">GET_USERS_VCARD</span>,
                    <span class="ActionScriptDefault_Text">vCardHandler</span><span class="ActionScriptBracket/Brace">)</span>;            
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// VCARD HANDLER
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">vCardHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IqStanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">namespace</span> <span class="ActionScriptDefault_Text">vCardTemp</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;vcard-temp&quot;</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">getXML</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">buddyJid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stanza</span>.<span class="ActionScriptDefault_Text">from</span>;
            
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddyJid</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">jid</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">gotAvatar</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">vCard</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XMLList</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">xml</span>.<span class="ActionScriptDefault_Text">vCardTemp</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">vCard</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">serverAvatar</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">vCard</span>.<span class="ActionScriptDefault_Text">vCardTemp</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">PHOTO</span>.<span class="ActionScriptDefault_Text">vCardTemp</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">BINVAL</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">localAvatar</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">XimppUtils</span>.<span class="ActionScriptDefault_Text">avatarToString</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">avatar</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptComment">// if we have a different avatar to the one on the server, then send a
</span>                <span class="ActionScriptComment">// vcard back to the server
</span>                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">serverAvatar</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">localAvatar</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">localAvatar</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptString">&quot;&quot;</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">vCard</span>.<span class="ActionScriptDefault_Text">vCardTemp</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">PHOTO</span>.<span class="ActionScriptDefault_Text">vCardTemp</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">BINVAL</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">localAvatar</span>;
                    <span class="ActionScriptDefault_Text">sendIq</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">jid</span>, <span class="ActionScriptDefault_Text">IQTypes</span>.<span class="ActionScriptDefault_Text">SET</span>, <span class="ActionScriptDefault_Text">vCard</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">])</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                
                <span class="ActionScriptComment">// now we have the avatar, resend the presence to make sure the 
</span>                <span class="ActionScriptComment">// avatar hash is sent to our buddies
</span>                <span class="ActionScriptDefault_Text">sendPresence</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">else</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">avatarString</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">xml</span>.<span class="ActionScriptDefault_Text">vCardTemp</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">vCard</span>.<span class="ActionScriptDefault_Text">vCardTemp</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">PHOTO</span>.<span class="ActionScriptDefault_Text">vCardTemp</span><span class="ActionScriptOperator">::</span><span class="ActionScriptDefault_Text">BINVAL</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Buddy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">getBuddyByJid</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buddyJid</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">XimppUtils</span>.<span class="ActionScriptDefault_Text">stringToAvatar</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">avatarString</span>, <span class="ActionScriptDefault_Text">buddy</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// SEND IQ
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptASDoc">/**
         * This function should really be in the seesmic library
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendIq</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tojid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">payload</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">XML</span>, <span class="ActionScriptDefault_Text">responseHandler</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Function</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">iqStanza</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IqStanza</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">IqStanza</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">xmpp</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">iqStanza</span>.<span class="ActionScriptDefault_Text">setID</span><span class="ActionScriptBracket/Brace">()</span>;

            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">responseHandler</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">addHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">IdHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">id</span>, <span class="ActionScriptDefault_Text">responseHandler</span><span class="ActionScriptBracket/Brace">))</span>;
            
            <span class="ActionScriptDefault_Text">iqStanza</span>.<span class="ActionScriptDefault_Text">setTo</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tojid</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">iqStanza</span>.<span class="ActionScriptDefault_Text">setType</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">iqStanza</span>.<span class="ActionScriptDefault_Text">setQuery</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">payload</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">iqStanza</span>.<span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>        
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// SEND PRESENCE
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendPresence</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">status</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Status</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">localStatus</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">customStatus</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">customStatus</span>;

            <span class="ActionScriptComment">// if we are connected and want to go offline, then disconnect
</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">connected</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">status</span>.<span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">Status</span>.<span class="ActionScriptDefault_Text">OFFLINE</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">disconnect</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// if we are already connected, then send the presence
</span>            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">connected</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">sendPresence</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">customStatus</span>, <span class="ActionScriptDefault_Text">status</span>.<span class="ActionScriptDefault_Text">toShow</span><span class="ActionScriptBracket/Brace">()</span>, <span class="ActionScriptString">&quot;5&quot;</span>, <span class="ActionScriptString">&quot;&quot;</span>, <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">gotAvatar</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">avatarHash</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptString">&quot;&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">serverSideStatus</span>.<span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">status</span>.<span class="ActionScriptDefault_Text">value</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// if we want to connect, then try to connect, if we are successful, then
</span>            <span class="ActionScriptComment">// we will send the presence once the session is established
</span>            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">status</span>.<span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">Status</span>.<span class="ActionScriptDefault_Text">OFFLINE</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">connect</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>    
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// SEND MESSAGE
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendMessage</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">toJid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">body</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">subject</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span>, <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&apos;chat&apos;</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">sendMessage</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">toJid</span>, <span class="ActionScriptDefault_Text">body</span>, <span class="ActionScriptDefault_Text">subject</span>, <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// ADD TO ROSTER 
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">addToRoster</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">toJid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">subscribe</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">sendIq</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">jid</span>,
                    <span class="ActionScriptDefault_Text">IQTypes</span>.<span class="ActionScriptDefault_Text">SET</span>,
                    <span class="ActionScriptDefault_Text">IQTypes</span>.<span class="ActionScriptDefault_Text">modifyRoster</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">toJid</span><span class="ActionScriptBracket/Brace">)</span>,
                    <span class="ActionScriptDefault_Text">modifyRosterHandler</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">subscribe</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">sendSubscribe</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">toJid</span>, <span class="ActionScriptDefault_Text">SubscriptionTypes</span>.<span class="ActionScriptDefault_Text">SUBSCRIBE</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// REMOVE FROM ROSTER
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">removeFromRoster</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">toJid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">sendIq</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">settings</span>.<span class="ActionScriptDefault_Text">userAccount</span>.<span class="ActionScriptDefault_Text">jid</span>, 
                    <span class="ActionScriptDefault_Text">IQTypes</span>.<span class="ActionScriptDefault_Text">SET</span>,
                    <span class="ActionScriptDefault_Text">IQTypes</span>.<span class="ActionScriptDefault_Text">modifyRoster</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">toJid</span>, <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>,
                    <span class="ActionScriptDefault_Text">modifyRosterHandler</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// MODIFY ROSTER HANDLER
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">modifyRosterHandler</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stanza</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IqStanza</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptASDoc">/**
             * TO DO:
             */</span>
            <span class="ActionScriptDefault_Text">appModel</span>.<span class="ActionScriptDefault_Text">log</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;modifyRosterHandler&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptComment">//-------------------------------
</span>        <span class="ActionScriptComment">// SEND SUBSCRIBE
</span>        <span class="ActionScriptComment">//-------------------------------
</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendSubscribe</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">toJid</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>, <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">xmpp</span>.<span class="ActionScriptDefault_Text">send</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&apos;&lt;presence to=&quot;&apos;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">toJid</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&apos;&quot; type=&quot;&apos;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&apos;&quot; /&gt;&apos;</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>

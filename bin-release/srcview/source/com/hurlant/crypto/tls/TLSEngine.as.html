<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>TLSEngine.as</title>
<link rel="stylesheet" type="text/css" href="../../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptASDoc">/**
 * TLSEngine
 * 
 * A TLS protocol implementation.
 * See comment below for some details.
 * Copyright (c) 2007 Henri Torgemane
 * 
 * Patched(heavily) by Bobby Parker (shortwave@gmail.com)
 * 
 * See LICENSE.txt for full license information.
 */</span>
<span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">crypto</span>.<span class="ActionScriptDefault_Text">tls</span> <span class="ActionScriptBracket/Brace">{</span>
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">crypto</span>.<span class="ActionScriptDefault_Text">cert</span>.<span class="ActionScriptDefault_Text">X509Certificate</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">crypto</span>.<span class="ActionScriptDefault_Text">cert</span>.<span class="ActionScriptDefault_Text">X509CertificateCollection</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">crypto</span>.<span class="ActionScriptDefault_Text">prng</span>.<span class="ActionScriptDefault_Text">Random</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">util</span>.<span class="ActionScriptDefault_Text">ArrayUtil</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">util</span>.<span class="ActionScriptDefault_Text">Hex</span>;
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">Event</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">EventDispatcher</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">ProgressEvent</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">ByteArray</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">IDataInput</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">IDataOutput</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">clearTimeout</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">setTimeout</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">com</span>.<span class="ActionScriptDefault_Text">hurlant</span>.<span class="ActionScriptDefault_Text">crypto</span>.<span class="ActionScriptDefault_Text">prng</span>.<span class="ActionScriptDefault_Text">ARC4</span>;


    <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">name</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&quot;close&quot;</span>, <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&quot;flash.events.Event&quot;</span><span class="ActionScriptBracket/Brace">)]</span>
    <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">name</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&quot;socketData&quot;</span>, <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&quot;flash.events.ProgressEvent&quot;</span><span class="ActionScriptBracket/Brace">)]</span>
    <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">name</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&quot;ready&quot;</span>, <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&quot;com.hurlant.crypto.tls.TLSEvent&quot;</span><span class="ActionScriptBracket/Brace">)]</span>
    <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">name</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&quot;data&quot;</span>, <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">&quot;com.hurlant.crypto.tls.TLSEvent&quot;</span><span class="ActionScriptBracket/Brace">)]</span>
    
    <span class="ActionScriptASDoc">/**
     * The heart of the TLS protocol.
     * This class can work in server or client mode.
     * 
     * This doesn&apos;t fully implement the TLS protocol.
     * 
     * Things missing that I&apos;d like to add:
     * - support for client-side certificates
     * - general code clean-up to make sure we don&apos;t have gaping securite holes
     * 
     * Things that aren&apos;t there that I won&apos;t add:
     * - support for &quot;export&quot; cypher suites (deprecated in later TLS versions)
     * - support for &quot;anon&quot; cypher suites (deprecated in later TLS versions)
     * 
     * Things that I&apos;m unsure about adding later:
     * - compression. Compressing encrypted streams is barely worth the CPU cycles.
     * - diffie-hellman based key exchange mechanisms. Nifty, but would we miss it?
     * 
     * @author henri
     * 
     */</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">TLSEngine</span> <span class="ActionScriptReserved">extends</span> <span class="ActionScriptDefault_Text">EventDispatcher</span> <span class="ActionScriptBracket/Brace">{</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">SERVER</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">CLIENT</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 1;
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">protocol_version</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>;


    
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">PROTOCOL_HANDSHAKE</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 22;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">PROTOCOL_ALERT</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 21;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">PROTOCOL_CHANGE_CIPHER_SPEC</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 20;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">PROTOCOL_APPLICATION_DATA</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 23;


        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">STATE_NEW</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptComment">// brand new. nothing happened yet
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">STATE_NEGOTIATING</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 1; <span class="ActionScriptComment">// we&apos;re figuring out what to use
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">STATE_READY</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 2; <span class="ActionScriptComment">// we&apos;re ready for AppData stuff to go over us.
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">STATE_CLOSED</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 3; <span class="ActionScriptComment">// we&apos;re done done.
</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_entity</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>; <span class="ActionScriptComment">// SERVER | CLIENT
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_config</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">TLSConfig</span>;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_state</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_securityParameters</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ISecurityParameters</span>;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_currentReadState</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IConnectionState</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_currentWriteState</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IConnectionState</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_pendingReadState</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IConnectionState</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_pendingWriteState</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IConnectionState</span>;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_handshakePayloads</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_handshakeRecords</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span>; <span class="ActionScriptComment">// For client-side certificate verify 
</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_iStream</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IDataInput</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_oStream</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IDataOutput</span>;
        
        <span class="ActionScriptComment">// temporary store for X509 certs received by this engine.
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_store</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">X509CertificateCollection</span>;
        <span class="ActionScriptComment">// the main certificate received from the other side.
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_otherCertificate</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">X509Certificate</span>;
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">peerCertificate</span><span class="ActionScriptBracket/Brace">()</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">X509Certificate</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_otherCertificate</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptComment">// If this isn&apos;t null, we expect this identity to be found in the Cert&apos;s Subject CN.
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_otherIdentity</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>;
        
        <span class="ActionScriptComment">// The client-side cert
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_myCertficate</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">X509Certificate</span>;
        <span class="ActionScriptComment">// My Identity
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_myIdentity</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span>;
        
        <span class="ActionScriptASDoc">/**
         * 
         * @param config        A TLSConfig instance describing how we&apos;re supposed to work
         * @param iStream        An input stream to read TLS data from
         * @param oStream        An output stream to write TLS data to
         * @param otherIdentity    An optional identifier. If set, this will be checked against the Subject CN of the other side&apos;s certificate.
         * 
         */</span>
        <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">TLSEngine</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">config</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">TLSConfig</span>, <span class="ActionScriptDefault_Text">iStream</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IDataInput</span>, <span class="ActionScriptDefault_Text">oStream</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IDataOutput</span>, <span class="ActionScriptDefault_Text">otherIdentity</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">_entity</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">config</span>.<span class="ActionScriptDefault_Text">entity</span>;
            <span class="ActionScriptDefault_Text">_config</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">config</span>;
            <span class="ActionScriptDefault_Text">_iStream</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">iStream</span>;
            <span class="ActionScriptDefault_Text">_oStream</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">oStream</span>;
            <span class="ActionScriptDefault_Text">_otherIdentity</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">otherIdentity</span>;
            
            <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">STATE_NEW</span>;
            
            <span class="ActionScriptComment">// Pick the right set of callbacks
</span>            <span class="ActionScriptDefault_Text">_entityHandshakeHandlers</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_entity</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">CLIENT</span> <span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">handshakeHandlersClient</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">handshakeHandlersServer</span>;
            
            <span class="ActionScriptComment">// setting up new security parameters needs to be controlled by...something.
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">version</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">SSLSecurityParameters</span>.<span class="ActionScriptDefault_Text">PROTOCOL_VERSION</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">_securityParameters</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">SSLSecurityParameters</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_entity</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">_securityParameters</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSSecurityParameters</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_entity</span>, <span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">certificate</span>, <span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">privateKey</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">protocol_version</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">version</span>;
            
            <span class="ActionScriptComment">// So this...why is it here, other than to preclude a possible null pointer situation?
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">states</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">getConnectionStates</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptDefault_Text">_currentReadState</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">states</span>.<span class="ActionScriptDefault_Text">read</span>;
            <span class="ActionScriptDefault_Text">_currentWriteState</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">states</span>.<span class="ActionScriptDefault_Text">write</span>;
            
            <span class="ActionScriptDefault_Text">_handshakePayloads</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            
            <span class="ActionScriptDefault_Text">_store</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">X509CertificateCollection</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * This starts the TLS negotiation for a TLS Client.
         * 
         * This is a no-op for a TLS Server.
         * 
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">start</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_entity</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">CLIENT</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">try</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">startHandshake</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">catch</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">handleTLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">dataAvailable</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:*</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">STATE_CLOSED</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span>; <span class="ActionScriptComment">// ignore
</span>            <span class="ActionScriptReserved">try</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">parseRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_iStream</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">catch</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">handleTLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">close</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">TLSError</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">STATE_CLOSED</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span>; <span class="ActionScriptComment">// ignore
</span>            <span class="ActionScriptComment">// ok. send an Alert to let the peer know
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">==</span><span class="ActionScriptReserved">null</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">STATE_READY</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// use canceled while handshaking. be nice about it
</span>                <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 1;
                <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">user_canceled</span>;
                <span class="ActionScriptDefault_Text">sendRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">PROTOCOL_ALERT</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 2;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">close_notify</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">e</span>.<span class="ActionScriptDefault_Text">errorID</span>;
                <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;TLSEngine shutdown triggered by &quot;</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">sendRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">PROTOCOL_ALERT</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">STATE_CLOSED</span>;
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Event</span>.<span class="ActionScriptDefault_Text">CLOSE</span><span class="ActionScriptBracket/Brace">))</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_packetQueue</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[]</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stream</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IDataInput</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">p</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptReserved">while</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span><span class="ActionScriptOperator">!=</span><span class="ActionScriptDefault_Text">STATE_CLOSED</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">stream</span>.<span class="ActionScriptDefault_Text">bytesAvailable</span><span class="ActionScriptOperator">&gt;</span>4<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_packetQueue</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">&gt;</span>0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">packet</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_packetQueue</span>.<span class="ActionScriptDefault_Text">shift</span><span class="ActionScriptBracket/Brace">()</span>;
                    <span class="ActionScriptDefault_Text">p</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">packet</span>.<span class="ActionScriptDefault_Text">data</span>;
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stream</span>.<span class="ActionScriptDefault_Text">bytesAvailable</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">&gt;=</span><span class="ActionScriptDefault_Text">packet</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptComment">// we have a whole packet. put together.
</span>                        <span class="ActionScriptDefault_Text">stream</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span>, <span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">packet</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptDefault_Text">parseOneRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">packet</span>.<span class="ActionScriptDefault_Text">type</span>, <span class="ActionScriptDefault_Text">packet</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">p</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptComment">// do another loop to parse any leftover record
</span>                        <span class="ActionScriptReserved">continue</span>;
                    <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptComment">// not enough. grab the data and park it.
</span>                        <span class="ActionScriptDefault_Text">stream</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span>, <span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">stream</span>.<span class="ActionScriptDefault_Text">bytesAvailable</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptDefault_Text">_packetQueue</span>.<span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">packet</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptReserved">continue</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptBracket/Brace">}</span>


                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stream</span>.<span class="ActionScriptDefault_Text">readByte</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ver</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stream</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">stream</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">&gt;</span>16384<span class="ActionScriptOperator">+</span>2048<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">// support compression and encryption overhead.
</span>                    <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Excessive TLS Record length: &quot;</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">record_overflow</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptComment">// Can pretty much assume that if I&apos;m here, I&apos;ve got a default config, so let&apos;s use it.
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ver</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">version</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Unsupported TLS version: &quot;</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">ver</span>.<span class="ActionScriptDefault_Text">toString</span><span class="ActionScriptBracket/Brace">(</span>16<span class="ActionScriptBracket/Brace">)</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">protocol_version</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptBracket/Brace">}</span>

                <span class="ActionScriptDefault_Text">p</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">actualLength</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Math</span>.<span class="ActionScriptDefault_Text">min</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stream</span>.<span class="ActionScriptDefault_Text">bytesAvailable</span>, <span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">stream</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span>, 0, <span class="ActionScriptDefault_Text">actualLength</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">actualLength</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">parseOneRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span>, <span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">p</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">_packetQueue</span>.<span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">({</span><span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">type</span>, <span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">p</span><span class="ActionScriptBracket/Brace">})</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        
        <span class="ActionScriptComment">// Protocol handler map, provides a mapping of protocol types to individual packet handlers
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">protocolHandlers</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">{</span> 23 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">parseApplicationData</span>, <span class="ActionScriptComment">// PROTOCOL_APPLICATION_DATA
</span>                                              22 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">parseHandshake</span>, <span class="ActionScriptComment">// PROTOCOL_HANDSHAKE
</span>                                              21 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">parseAlert</span>, <span class="ActionScriptComment">// PROTOCOL_ALERT
</span>                                              20 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">parseChangeCipherSpec</span> <span class="ActionScriptBracket/Brace">}</span>; <span class="ActionScriptComment">// PROTOCOL_CHANGE_CIPHER_SPEC
</span>        
        <span class="ActionScriptASDoc">/**
         * Modified to support the notion of a handler map(see above ), since it makes for better clarity (IMHO of course).
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseOneRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>, <span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>, <span class="ActionScriptDefault_Text">p</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">p</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_currentReadState</span>.<span class="ActionScriptDefault_Text">decrypt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span>, <span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">p</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">&gt;</span>16384<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span> 
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Excessive Decrypted TLS Record length: &quot;</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">record_overflow</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">protocolHandlers</span>.<span class="ActionScriptDefault_Text">hasOwnProperty</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">while</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">p</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">p</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">protocolHandlers</span><span class="ActionScriptBracket/Brace">[</span> <span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptBracket/Brace">](</span> <span class="ActionScriptDefault_Text">p</span> <span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Unsupported TLS Record Content Type: &quot;</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">type</span>.<span class="ActionScriptDefault_Text">toString</span><span class="ActionScriptBracket/Brace">(</span> 16 <span class="ActionScriptBracket/Brace">)</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">unexpected_message</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">///////// handshake handling
</span>        <span class="ActionScriptComment">// session identifier
</span>        <span class="ActionScriptComment">// peer certificate
</span>        <span class="ActionScriptComment">// compression method
</span>        <span class="ActionScriptComment">// cipher spec
</span>        <span class="ActionScriptComment">// master secret
</span>        <span class="ActionScriptComment">// is resumable
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">HANDSHAKE_HELLO_REQUEST</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">HANDSHAKE_CLIENT_HELLO</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 1;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">HANDSHAKE_SERVER_HELLO</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 2;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">HANDSHAKE_CERTIFICATE</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 11;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">HANDSHAKE_SERVER_KEY_EXCHANGE</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 12;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">HANDSHAKE_CERTIFICATE_REQUEST</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 13;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">HANDSHAKE_HELLO_DONE</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 14;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">HANDSHAKE_CERTIFICATE_VERIFY</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 15;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">HANDSHAKE_CLIENT_KEY_EXCHANGE</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 16;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">HANDSHAKE_FINISHED</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 20;

        <span class="ActionScriptComment">// Server handshake handler map
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">handshakeHandlersServer</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">{</span> 0 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">notifyStateError</span>, <span class="ActionScriptComment">// HANDSHAKE_HELLO_REQUEST
</span>                                                       1 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">parseHandshakeClientHello</span>, <span class="ActionScriptComment">// HANDSHAKE_CLIENT_HELLO
</span>                                                       2 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">notifyStateError</span>, <span class="ActionScriptComment">// HANDSHAKE_SERVER_HELLO 
</span>                                                       11 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">loadCertificates</span>, <span class="ActionScriptComment">// HANDSHAKE_CERTIFICATE
</span>                                                       12 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">notifyStateError</span>, <span class="ActionScriptComment">// HANDSHAKE_SERVER_KEY_EXCHANGE
</span>                                                       13 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">notifyStateError</span>, <span class="ActionScriptComment">// HANDSHAKE_CERTIFICATE_REQUEST
</span>                                                       14 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">notifyStateError</span>, <span class="ActionScriptComment">// HANDSHAKE_HELLO_DONE
</span>                                                       15 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">notifyStateError</span>, <span class="ActionScriptComment">// HANDSHAKE_CERTIFICATE_VERIFY
</span>                                                       16 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">parseHandshakeClientKeyExchange</span>, <span class="ActionScriptComment">// HANDSHAKE_CLIENT_KEY_EXCHANGE
</span>                                                       20 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">verifyHandshake</span> <span class="ActionScriptComment">// HANDSHAKE_FINISHED                                                       
</span>                                                        <span class="ActionScriptBracket/Brace">}</span>;
                                                        
        <span class="ActionScriptComment">// Client handshake handler map                                        
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">handshakeHandlersClient</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">{</span> 0 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">parseHandshakeHello</span>, <span class="ActionScriptComment">// HANDSHAKE_HELLO_REQUEST
</span>                                                       1 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">notifyStateError</span>, <span class="ActionScriptComment">// HANDSHAKE_CLIENT_HELLO
</span>                                                       2 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">parseHandshakeServerHello</span>, <span class="ActionScriptComment">// HANDSHAKE_SERVER_HELLO
</span>                                                       11 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">loadCertificates</span>, <span class="ActionScriptComment">// HANDSHAKE_CERTIFICATE
</span>                                                       12 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">parseServerKeyExchange</span>, <span class="ActionScriptComment">// HANDSHAKE_SERVER_KEY_EXCHANGE
</span>                                                       13 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">setStateRespondWithCertificate</span>, <span class="ActionScriptComment">// HANDSHAKE_CERTIFICATE
</span>                                                       14 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">sendClientAck</span>, <span class="ActionScriptComment">// HANDSHAKE_HELLO_DONE  
</span>                                                       15 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">notifyStateError</span>, <span class="ActionScriptComment">// HANDSHAKE_CERTIFICATE_VERIFY
</span>                                                       16 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">notifyStateError</span>, <span class="ActionScriptComment">// HANDSHAKE_CLIENT_KEY_EXCHANGE
</span>                                                       20 <span class="ActionScriptOperator">:</span> <span class="ActionScriptDefault_Text">verifyHandshake</span> <span class="ActionScriptComment">// HANDSHAKE_FINISHED
</span>                                                        <span class="ActionScriptBracket/Brace">}</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_entityHandshakeHandlers</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_handshakeCanContinue</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>; <span class="ActionScriptComment">// For handling cases where I might need to pause processing during a handshake (cert issues, etc.).
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_handshakeQueue</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[]</span>;
        <span class="ActionScriptASDoc">/**
         * The handshake is always started by the client.
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">startHandshake</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">STATE_NEGOTIATING</span>;
            <span class="ActionScriptComment">// reset some other handshake state. XXX
</span>            <span class="ActionScriptDefault_Text">sendClientHello</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * Handle the incoming handshake packet.
         * 
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseHandshake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptBracket/Brace">{</span>
            
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">&lt;</span>4<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Handshake packet is way too short. bailing.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptBracket/Brace">}</span>

            <span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">p</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readUnsignedByte</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tmp</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readUnsignedByte</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tmp</span><span class="ActionScriptOperator">&lt;&lt;</span>16<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">|</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readUnsignedShort</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">+</span>4<span class="ActionScriptOperator">&gt;</span><span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// partial read.
</span>                <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Handshake packet is incomplete. bailing.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptBracket/Brace">}</span>

            <span class="ActionScriptComment">// we need to copy the record, to have a valid FINISHED exchange.
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">!=</span><span class="ActionScriptDefault_Text">HANDSHAKE_FINISHED</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span> 
                <span class="ActionScriptDefault_Text">_handshakePayloads</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span>, 0, <span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">+</span>4<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> 
            
            <span class="ActionScriptComment">// Surf the handler map and find the right handler for this handshake packet type. 
</span>            <span class="ActionScriptComment">// I modified the individual handlers so they encapsulate all possible knowledge 
</span>            <span class="ActionScriptComment">// about the incoming packet type, so no previous handling or massaging of the data 
</span>            <span class="ActionScriptComment">// is required, as was the case using the switch statement. BP
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_entityHandshakeHandlers</span>.<span class="ActionScriptDefault_Text">hasOwnProperty</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_entityHandshakeHandlers</span><span class="ActionScriptBracket/Brace">[</span> <span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">is</span> <span class="ActionScriptDefault_Text">Function</span><span class="ActionScriptBracket/Brace">)</span> 
                    <span class="ActionScriptDefault_Text">_entityHandshakeHandlers</span><span class="ActionScriptBracket/Brace">[</span> <span class="ActionScriptDefault_Text">type</span> <span class="ActionScriptBracket/Brace">](</span> <span class="ActionScriptDefault_Text">rec</span> <span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptString">&quot;Unimplemented or unknown handshake type!&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">internal_error</span> <span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// Get set up for the next packet.
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">+</span>4<span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">n</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
                <span class="ActionScriptDefault_Text">n</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span>,<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">+</span>4, <span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">-</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">+</span>4<span class="ActionScriptBracket/Brace">))</span>;
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">n</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * Throw an error when the detected handshake state isn&apos;t a valid state for the given entity type (client vs. server, etc. ).
         * This really should abort the handshake, since there&apos;s no case in which a server should EVER be confused about the type of entity it is. BP
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">notifyStateError</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptString">&quot;Invalid handshake state for a TLS Entity type of &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">_entity</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">internal_error</span> <span class="ActionScriptBracket/Brace">)</span>; 
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * two unimplemented functions
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseClientKeyExchange</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptString">&quot;ClientKeyExchange is currently unimplemented!&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">internal_error</span> <span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseServerKeyExchange</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptString">&quot;ServerKeyExchange is currently unimplemented!&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">internal_error</span> <span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * Test the server&apos;s Finished message for validity against the data we know about. Only slightly rewritten. BP
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">verifyHandshake</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// Get the Finished message
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">verifyData</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptComment">// This, in the vain hope that noboby is using SSL 2 anymore
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">version</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">SSLSecurityParameters</span>.<span class="ActionScriptDefault_Text">PROTOCOL_VERSION</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">verifyData</span>, 0, 36<span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// length should be (in fact, better be) 16 + 20 (md5-size + sha1-size)
</span>            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">// presuming TLS
</span>                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">verifyData</span>, 0, 12<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">computeVerifyData</span><span class="ActionScriptBracket/Brace">(</span>1<span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">_entity</span>, <span class="ActionScriptDefault_Text">_handshakePayloads</span><span class="ActionScriptBracket/Brace">)</span>;

            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(A</span><span class="ActionScriptDefault_Text">rrayUtil</span>.<span class="ActionScriptDefault_Text">equals</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">verifyData</span>, <span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">STATE_READY</span>;
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSEvent</span><span class="ActionScriptBracket/Brace">(T</span><span class="ActionScriptDefault_Text">LSEvent</span>.<span class="ActionScriptDefault_Text">READY</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Invalid Finished mac.&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">bad_record_mac</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptComment">// enforceClient/enforceServer removed in favor of state-driven function maps
</span>
        <span class="ActionScriptASDoc">/**
         * Handle a HANDSHAKE_HELLO
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseHandshakeHello</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">STATE_READY</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Received an HELLO_REQUEST before being in state READY. ignoring.&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">return</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">_handshakePayloads</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptDefault_Text">startHandshake</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * Handle a HANDSHAKE_CLIENT_KEY_EXCHANGE
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseHandshakeClientKeyExchange</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">useRSA</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// skip 2 bytes for length.
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">cipher</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cipher</span>, 0, <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">preMasterSecret</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
                <span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">privateKey</span>.<span class="ActionScriptDefault_Text">decrypt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cipher</span>, <span class="ActionScriptDefault_Text">preMasterSecret</span>, <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">setPreMasterSecret</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">preMasterSecret</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptComment">// now is a good time to get our pending states
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">o</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">getConnectionStates</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">_pendingReadState</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">o</span>.<span class="ActionScriptDefault_Text">read</span>;
                <span class="ActionScriptDefault_Text">_pendingWriteState</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">o</span>.<span class="ActionScriptDefault_Text">write</span>;
                
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;parseHandshakeClientKeyExchange not implemented for DH modes.&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">internal_error</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/** 
         * Handle HANDSHAKE_SERVER_HELLO - client-side
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseHandshakeServerHello</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IDataInput</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ver</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ver</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">version</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Unsupported TLS version: &quot;</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">ver</span>.<span class="ActionScriptDefault_Text">toString</span><span class="ActionScriptBracket/Brace">(</span>16<span class="ActionScriptBracket/Brace">)</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">protocol_version</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">random</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">random</span>, 0, 32<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">session_length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readByte</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">session</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">session_length</span> <span class="ActionScriptOperator">&gt;</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// some implementations don&apos;t assign a session ID
</span>                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">session</span>, 0, <span class="ActionScriptDefault_Text">session_length</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">setCipher</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">())</span>; 
            <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">setCompression</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readByte</span><span class="ActionScriptBracket/Brace">())</span>;
            <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">setServerRandom</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">random</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         *  Handle HANDSHAKE_CLIENT_HELLO - server side
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseHandshakeClientHello</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IDataInput</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ret</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ver</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>; 
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ver</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">version</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Unsupported TLS version: &quot;</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">ver</span>.<span class="ActionScriptDefault_Text">toString</span><span class="ActionScriptBracket/Brace">(</span>16<span class="ActionScriptBracket/Brace">)</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">protocol_version</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">random</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">random</span>, 0, 32<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">session_length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readByte</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">session</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">session_length</span> <span class="ActionScriptOperator">&gt;</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// some implementations don&apos;t assign a session ID
</span>                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">session</span>, 0, <span class="ActionScriptDefault_Text">session_length</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">suites</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[]</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">suites_length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span>0;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">suites_length</span><span class="ActionScriptOperator">/</span>2;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">suites</span>.<span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">())</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">compressions</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[]</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">comp_length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readByte</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">=</span>0;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">comp_length</span>;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">compressions</span>.<span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readByte</span><span class="ActionScriptBracket/Brace">())</span>;
            <span class="ActionScriptBracket/Brace">}</span>

            <span class="ActionScriptDefault_Text">ret</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptDefault_Text">random</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">random</span>, <span class="ActionScriptDefault_Text">session</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">session</span>, <span class="ActionScriptDefault_Text">suites</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">suites</span>, <span class="ActionScriptDefault_Text">compressions</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">compressions</span><span class="ActionScriptBracket/Brace">}</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sofar</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> 2<span class="ActionScriptOperator">+</span>32<span class="ActionScriptOperator">+</span>1<span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">session_length</span><span class="ActionScriptOperator">+</span>2<span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">suites_length</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">comp_length</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">extensions</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[]</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sofar</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// we have extensions. great.
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ext_total_length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ext_total_length</span><span class="ActionScriptOperator">&gt;</span>0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ext_type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>;
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ext_length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>;
                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ext_data</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
                    <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ext_data</span>, 0, <span class="ActionScriptDefault_Text">ext_length</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptDefault_Text">ext_total_length</span> <span class="ActionScriptOperator">-=</span> 4<span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">ext_length</span>;
                    <span class="ActionScriptDefault_Text">extensions</span>.<span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">({</span><span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ext_type</span>, <span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ext_length</span>, <span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ext_data</span><span class="ActionScriptBracket/Brace">})</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">ret</span>.<span class="ActionScriptDefault_Text">ext</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">extensions</span>;
            
            <span class="ActionScriptDefault_Text">sendServerHello</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ret</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">sendCertificate</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptComment">// TODO: Modify to handle case of requesting a certificate from the client, for &quot;client authentication&quot;, 
</span>            <span class="ActionScriptComment">// and testing purposes, will probably never actually need it.
</span>            <span class="ActionScriptDefault_Text">sendServerHelloDone</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendClientHello</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptComment">// version - modified to support version attribute from ISecurityParameters
</span>            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">version</span><span class="ActionScriptBracket/Brace">)</span>;  
            <span class="ActionScriptComment">// random
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">prng</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Random</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Random</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">clientRandom</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptDefault_Text">prng</span>.<span class="ActionScriptDefault_Text">nextBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">clientRandom</span>, 32<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">setClientRandom</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">clientRandom</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">clientRandom</span>,0,32<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// session
</span>            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>32<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">prng</span>.<span class="ActionScriptDefault_Text">nextBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rec</span>, 32<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// Cipher suites
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">cs</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">cipherSuites</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span>2<span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">cs</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">=</span>0;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">cs</span>.<span class="ActionScriptDefault_Text">length</span>;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cs</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">])</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// Compression
</span>            <span class="ActionScriptDefault_Text">cs</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">compressions</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cs</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">=</span>0;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">cs</span>.<span class="ActionScriptDefault_Text">length</span>;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cs</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">])</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// no extensions, yet.
</span>            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">sendHandshake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">HANDSHAKE_CLIENT_HELLO</span>, <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">findMatch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">a1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">a2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">=</span>0;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">a1</span>.<span class="ActionScriptDefault_Text">length</span>;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">a1</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">a2</span>.<span class="ActionScriptDefault_Text">indexOf</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">&gt;-</span>1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">e</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptOperator">-</span>1;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendServerHello</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">v</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">cipher</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">findMatch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">cipherSuites</span>, <span class="ActionScriptDefault_Text">v</span>.<span class="ActionScriptDefault_Text">suites</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cipher</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;No compatible cipher found.&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">handshake_failure</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">setCipher</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cipher</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">comp</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">findMatch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">compressions</span>, <span class="ActionScriptDefault_Text">v</span>.<span class="ActionScriptDefault_Text">compressions</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">comp</span> <span class="ActionScriptOperator">==</span> 01<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;No compatible compression method found.&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">handshake_failure</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">setCompression</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">comp</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">setClientRandom</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">v</span>.<span class="ActionScriptDefault_Text">random</span><span class="ActionScriptBracket/Brace">)</span>;


            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">version</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">prng</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Random</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Random</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">serverRandom</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptDefault_Text">prng</span>.<span class="ActionScriptDefault_Text">nextBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">serverRandom</span>, 32<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">setServerRandom</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">serverRandom</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">serverRandom</span>,0,32<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// session
</span>            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>32<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">prng</span>.<span class="ActionScriptDefault_Text">nextBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rec</span>, 32<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// Cipher suite
</span>            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">v</span>.<span class="ActionScriptDefault_Text">suites</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">])</span>;
            <span class="ActionScriptComment">// Compression
</span>            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">v</span>.<span class="ActionScriptDefault_Text">compressions</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">])</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">sendHandshake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">HANDSHAKE_SERVER_HELLO</span>, <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sendClientCert</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">setStateRespondWithCertificate</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">r</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">sendClientCert</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendCertificate</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">r</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span> <span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">cert</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">certificate</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptComment">// Look for a certficate chain, if we have one, send it, if we don&apos;t, send an empty record.
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cert</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span> 
                <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">cert</span>.<span class="ActionScriptDefault_Text">length</span>;
                <span class="ActionScriptDefault_Text">len2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">cert</span>.<span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">+</span> 3;
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len2</span><span class="ActionScriptOperator">&gt;&gt;</span>16<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len2</span><span class="ActionScriptOperator">&amp;</span>65535<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">&gt;&gt;</span>16<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">&amp;</span>65535<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cert</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span> 0 <span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span> 0 <span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">sendHandshake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">HANDSHAKE_CERTIFICATE</span>, <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendCertificateVerify</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptComment">// Encrypt the handshake payloads here
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">computeCertificateVerify</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_entity</span>, <span class="ActionScriptDefault_Text">_handshakePayloads</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">=</span>0;
            <span class="ActionScriptDefault_Text">sendHandshake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">HANDSHAKE_CERTIFICATE_VERIFY</span>, <span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendServerHelloDone</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptDefault_Text">sendHandshake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">HANDSHAKE_HELLO_DONE</span>, <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendClientKeyExchange</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">useRSA</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">p</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
                <span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">version</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">prng</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Random</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Random</span>;
                <span class="ActionScriptDefault_Text">prng</span>.<span class="ActionScriptDefault_Text">nextBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span>, 46<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;

                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">preMasterSecret</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
                <span class="ActionScriptDefault_Text">preMasterSecret</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span>, 0, <span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">preMasterSecret</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;
                <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">setPreMasterSecret</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">preMasterSecret</span><span class="ActionScriptBracket/Brace">)</span>;
                             
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">enc_key</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
                <span class="ActionScriptDefault_Text">_otherCertificate</span>.<span class="ActionScriptDefault_Text">getPublicKey</span><span class="ActionScriptBracket/Brace">()</span>.<span class="ActionScriptDefault_Text">encrypt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">preMasterSecret</span>, <span class="ActionScriptDefault_Text">enc_key</span>, <span class="ActionScriptDefault_Text">preMasterSecret</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>; 
                
                <span class="ActionScriptDefault_Text">enc_key</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
                
                <span class="ActionScriptComment">// TLS requires the size of the premaster key be sent BUT
</span>                <span class="ActionScriptComment">// SSL 3.0 does not
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">version</span> <span class="ActionScriptOperator">&gt;</span> 0<span class="ActionScriptDefault_Text">x0300</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span> 
                    <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">enc_key</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">enc_key</span>, 0, <span class="ActionScriptDefault_Text">enc_key</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">=</span>0;
                
                <span class="ActionScriptDefault_Text">sendHandshake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">HANDSHAKE_CLIENT_KEY_EXCHANGE</span>, <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptComment">// now is a good time to get our pending states
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">o</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Object</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">getConnectionStates</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">_pendingReadState</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">o</span>.<span class="ActionScriptDefault_Text">read</span>;
                <span class="ActionScriptDefault_Text">_pendingWriteState</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">o</span>.<span class="ActionScriptDefault_Text">write</span>;
                
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Non-RSA Client Key Exchange not implemented.&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">internal_error</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendFinished</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">computeVerifyData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_entity</span>, <span class="ActionScriptDefault_Text">_handshakePayloads</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">=</span>0;
            <span class="ActionScriptDefault_Text">sendHandshake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">HANDSHAKE_FINISHED</span>, <span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">length</span>, <span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendHandshake</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>, <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>, <span class="ActionScriptDefault_Text">payload</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IDataInput</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">payload</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rec</span>, <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">position</span>, <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_handshakePayloads</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rec</span>, 0, <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">sendRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">PROTOCOL_HANDSHAKE</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendChangeCipherSpec</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 1;
            <span class="ActionScriptDefault_Text">sendRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">PROTOCOL_CHANGE_CIPHER_SPEC</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptComment">// right after, switch the cipher for writing.
</span>            <span class="ActionScriptDefault_Text">_currentWriteState</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_pendingWriteState</span>;
            <span class="ActionScriptDefault_Text">_pendingWriteState</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;    
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendApplicationData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span>, <span class="ActionScriptDefault_Text">offset</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span>0, <span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span>0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">length</span>;
            <span class="ActionScriptComment">// BIG FAT WARNING: Patch from Arlen Cuss ALA As3crypto group on Google code. 
</span>            <span class="ActionScriptComment">// This addresses data overflow issues when the packet size hits the max length boundary.
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">==</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">length</span>;  
            <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">len</span><span class="ActionScriptOperator">&gt;</span>16384<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">data</span>, <span class="ActionScriptDefault_Text">offset</span>, 16384<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;
                <span class="ActionScriptDefault_Text">sendRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">PROTOCOL_APPLICATION_DATA</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">offset</span> <span class="ActionScriptOperator">+=</span> 16384;
                <span class="ActionScriptDefault_Text">len</span> <span class="ActionScriptOperator">-=</span> 16384;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">data</span>, <span class="ActionScriptDefault_Text">offset</span>, <span class="ActionScriptDefault_Text">len</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// trace(&quot;Data I&apos;m sending...&quot; + Hex.fromArray( data ));
</span>            <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">sendRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">PROTOCOL_APPLICATION_DATA</span>, <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendRecord</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>, <span class="ActionScriptDefault_Text">payload</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// encrypt
</span>            <span class="ActionScriptDefault_Text">payload</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_currentWriteState</span>.<span class="ActionScriptDefault_Text">encrypt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span>, <span class="ActionScriptDefault_Text">payload</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptDefault_Text">_oStream</span>.<span class="ActionScriptDefault_Text">writeByte</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">type</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_oStream</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_securityParameters</span>.<span class="ActionScriptDefault_Text">version</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_oStream</span>.<span class="ActionScriptDefault_Text">writeShort</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">payload</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_oStream</span>.<span class="ActionScriptDefault_Text">writeBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">payload</span>, 0, <span class="ActionScriptDefault_Text">payload</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptDefault_Text">scheduleWrite</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_writeScheduler</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">scheduleWrite</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_writeScheduler</span><span class="ActionScriptOperator">!=</span>0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span>;
            <span class="ActionScriptDefault_Text">_writeScheduler</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">setTimeout</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">commitWrite</span>, 0<span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">commitWrite</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">clearTimeout</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_writeScheduler</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_writeScheduler</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">STATE_CLOSED</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ProgressEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ProgressEvent</span>.<span class="ActionScriptDefault_Text">SOCKET_DATA</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">sendClientAck</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">_handshakeCanContinue</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// If I have a pending cert request, send it
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sendClientCert</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">sendCertificate</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptComment">// send a client key exchange
</span>                <span class="ActionScriptDefault_Text">sendClientKeyExchange</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptComment">// Send the certificate verify, if we have one
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">certificate</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">sendCertificateVerify</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptComment">// send a change cipher spec
</span>                <span class="ActionScriptDefault_Text">sendChangeCipherSpec</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptComment">// send a finished
</span>                <span class="ActionScriptDefault_Text">sendFinished</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptASDoc">/**
         * Vaguely gross function that parses a RSA key out of a certificate.
         * 
         * As long as that certificate looks just the way we expect it to.
         * 
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">loadCertificates</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">rec</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tmp</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readByte</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">certs_len</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tmp</span><span class="ActionScriptOperator">&lt;&lt;</span>16<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">|</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">certs</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">[]</span>;
            
            <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">certs_len</span><span class="ActionScriptOperator">&gt;</span>0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">tmp</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readByte</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">cert_len</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">uint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tmp</span><span class="ActionScriptOperator">&lt;&lt;</span>16<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">|</span> <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readShort</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">cert</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ByteArray</span>;
                <span class="ActionScriptDefault_Text">rec</span>.<span class="ActionScriptDefault_Text">readBytes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cert</span>, 0, <span class="ActionScriptDefault_Text">cert_len</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">certs</span>.<span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">cert</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">certs_len</span> <span class="ActionScriptOperator">-=</span> 3 <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">cert_len</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">firstCert</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">X509Certificate</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">=</span>0;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">certs</span>.<span class="ActionScriptDefault_Text">length</span>;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">x509</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">X509Certificate</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">X509Certificate</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">certs</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">])</span>;
                <span class="ActionScriptDefault_Text">_store</span>.<span class="ActionScriptDefault_Text">addCertificate</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">x509</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">firstCert</span><span class="ActionScriptOperator">==</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">firstCert</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">x509</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>

            
            <span class="ActionScriptComment">// Test first for trust override parameters
</span>            <span class="ActionScriptComment">// This nice trust override stuff comes from Joey Parrish via As3crypto forums
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">certTrusted</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">trustAllCertificates</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">certTrusted</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>; <span class="ActionScriptComment">// Blatantly trust everything
</span>            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">trustSelfSignedCertificates</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// Self-signed certs
</span>                <span class="ActionScriptDefault_Text">certTrusted</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">firstCert</span>.<span class="ActionScriptDefault_Text">isSelfSigned</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Date</span><span class="ActionScriptBracket/Brace">)</span>; 
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// Certs with a signer in the CA store - realistically, I should setup an event chain to handle this
</span>                <span class="ActionScriptDefault_Text">certTrusted</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">firstCert</span>.<span class="ActionScriptDefault_Text">isSigned</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_store</span>, <span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">CAStore</span> <span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
    
            <span class="ActionScriptComment">// Good so far
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">certTrusted</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                            
                <span class="ActionScriptComment">// ok, that&apos;s encouraging. now for the hostname match.
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_otherIdentity</span><span class="ActionScriptOperator">==</span><span class="ActionScriptReserved">null</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">ignoreCommonNameMismatch</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">// we don&apos;t care who we&apos;re talking with. groovy.
</span>                    <span class="ActionScriptDefault_Text">_otherCertificate</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">firstCert</span>;
                <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">// use regex to handle wildcard certs
</span>                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">commonName</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">firstCert</span>.<span class="ActionScriptDefault_Text">getCommonName</span><span class="ActionScriptBracket/Brace">()</span>;
                    <span class="ActionScriptComment">// replace all regex special characters with escaped version, except for asterisk
</span>                    <span class="ActionScriptComment">// replace the asterisk with a regex sequence to match one or more non-dot characters
</span>                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">commonNameRegex</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">RegExp</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">RegExp</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">commonName</span>.<span class="ActionScriptDefault_Text">replace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">/[\^\\\-$.[\]|()?+{}]/</span><span class="ActionScriptDefault_Text">g</span>, <span class="ActionScriptString">&quot;\\$&amp;&quot;</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">replace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">/</span><span class="ActionScriptDefault_Text">\</span><span class="ActionScriptOperator">*/</span><span class="ActionScriptDefault_Text">g</span>, <span class="ActionScriptString">&quot;[^.]+&quot;</span><span class="ActionScriptBracket/Brace">)</span>, <span class="ActionScriptString">&quot;gi&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">commonNameRegex</span>.<span class="ActionScriptDefault_Text">exec</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_otherIdentity</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">_otherCertificate</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">firstCert</span>;
                    <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">promptUserForAcceptCert</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptDefault_Text">_handshakeCanContinue</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSEvent</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">TLSEvent</span>.<span class="ActionScriptDefault_Text">PROMPT_ACCEPT_CERT</span> <span class="ActionScriptBracket/Brace">))</span>;
                        <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                             <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Invalid common name: &quot;</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">firstCert</span>.<span class="ActionScriptDefault_Text">getCommonName</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">+</span><span class="ActionScriptString">&quot;, expected &quot;</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">_otherIdentity</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">bad_certificate</span><span class="ActionScriptBracket/Brace">)</span>;
                         <span class="ActionScriptBracket/Brace">}</span>
                    <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// Let&apos;s ask the user if we can accept this cert. I&apos;m not certain of the behaviour in case of timeouts, 
</span>                <span class="ActionScriptComment">// so I probably need to handle the case by killing and restarting the connection rather than continuing if it becomes 
</span>                <span class="ActionScriptComment">// an issue. We shall see. BP
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_config</span>.<span class="ActionScriptDefault_Text">promptUserForAcceptCert</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">_handshakeCanContinue</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                    <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSEvent</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">TLSEvent</span>.<span class="ActionScriptDefault_Text">PROMPT_ACCEPT_CERT</span> <span class="ActionScriptBracket/Brace">))</span>;
                <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptComment">// Cannot continue, die.
</span>                    <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Cannot verify certificate&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">bad_certificate</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// Accept the peer cert, and keep going
</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">acceptPeerCertificate</span><span class="ActionScriptBracket/Brace">()</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">_handshakeCanContinue</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptDefault_Text">sendClientAck</span><span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptReserved">null</span> <span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// Step off biotch! No trust for you!
</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">rejectPeerCertificate</span><span class="ActionScriptBracket/Brace">()</span> <span class="ActionScriptOperator">:</span> <span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Peer certificate not accepted!&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">bad_certificate</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseAlert</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//throw new Error(&quot;Alert not implemented.&quot;);
</span>            <span class="ActionScriptComment">// 7.2
</span>            <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;GOT ALERT! type=&quot;</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">p</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">])</span>;
            <span class="ActionScriptDefault_Text">close</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseChangeCipherSpec</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">p</span>.<span class="ActionScriptDefault_Text">readUnsignedByte</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_pendingReadState</span><span class="ActionScriptOperator">==</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Not ready to Change Cipher Spec, damnit.&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">unexpected_message</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">_currentReadState</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_pendingReadState</span>;
            <span class="ActionScriptDefault_Text">_pendingReadState</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptComment">// 7.1
</span>        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">parseApplicationData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ByteArray</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">STATE_READY</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;Too soon for data!&quot;</span>, <span class="ActionScriptDefault_Text">TLSError</span>.<span class="ActionScriptDefault_Text">unexpected_message</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">return</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">TLSEvent</span><span class="ActionScriptBracket/Brace">(T</span><span class="ActionScriptDefault_Text">LSEvent</span>.<span class="ActionScriptDefault_Text">DATA</span>, <span class="ActionScriptDefault_Text">p</span><span class="ActionScriptBracket/Brace">))</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">handleTLSError</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">TLSError</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// basic rules to keep things simple:
</span>            <span class="ActionScriptComment">// - Make a good faith attempt at notifying peers
</span>            <span class="ActionScriptComment">// - TLSErrors are always fatal.
</span>            <span class="ActionScriptComment">// BP: Meh...not always. Common Name mismatches appear to be common on servers. Instead of closing, let&apos;s pause, and ask for confirmation 
</span>            <span class="ActionScriptComment">// before we tear the connection down.
</span>            
            <span class="ActionScriptDefault_Text">close</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>

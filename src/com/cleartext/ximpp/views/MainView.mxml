<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas
	width="100%" height="100%"
	initialize="init();"
	backgroundColor="0x000000"
	xmlns:mx="http://www.adobe.com/2006/mxml"
	xmlns:header="com.cleartext.ximpp.views.header.*"
	xmlns:buddies="com.cleartext.ximpp.views.buddies.*" 
	xmlns:messages="com.cleartext.ximpp.views.messages.*">

	<mx:Script>
		<![CDATA[
			import com.cleartext.ximpp.views.popup.PreferenceWindow;
			import mx.core.IFlexDisplayObject;
			import com.cleartext.ximpp.views.popup.EditBuddyWindow;
			import com.cleartext.ximpp.views.popup.SubscriptionRequestWindow;
			import com.cleartext.ximpp.events.PopUpEvent;
			import com.cleartext.ximpp.views.popup.AddBuddyWindow;
			import com.cleartext.ximpp.models.ApplicationModel;
			import mx.events.CloseEvent;
			import mx.managers.PopUpManager;
			import mx.controls.Alert;

			[Autowire]
			[Bindable]
			public var appModel:ApplicationModel;		
		
			private function init():void
			{
				appModel.init();
			}
			
			[Mediate(event="PopUpEvent.PREFERENCES_WINDOW")]
			public function showPreferencesWindow(event:PopUpEvent):void
			{
				initializePopUp(new PreferenceWindow());
			}
			
			[Mediate(event="PopUpEvent.ADVANCED_SEARCH_WINDOW")]
			public function showAdvancedSearchWindow(event:PopUpEvent):void
			{
				Alert.show("Advanced search is not currently implemented.","Advanced Search");
			}
			
			[Mediate(event="PopUpEvent.ADD_NEW_BUDDY_WINDOW")]
			public function showAddBuddyWindow(event:PopUpEvent):void
			{
				initializePopUp(new AddBuddyWindow());
			}

			[Mediate(event="PopUpEvent.SUBSCRIPTION_REQUEST_WINDOW")]
			public function showSubscriptionRequest(event:PopUpEvent):void
			{
				var buddyExists:Boolean = appModel.rosterItems.containsJid(event.jid);

				var window:SubscriptionRequestWindow = new SubscriptionRequestWindow();
				window.fromJid = event.jid;
				window.addToRoster = !buddyExists;
				initializePopUp(window);
			}

			[Mediate(event="PopUpEvent.EDIT_BUDDY_WINDOW")]
			public function showEditBuddyWindow(event:PopUpEvent):void
			{
				var window:EditBuddyWindow = new EditBuddyWindow();
				initializePopUp(window);
				window.buddy = event.buddy;
			}
			
			private function initializePopUp(window:IFlexDisplayObject):void
			{
				window.addEventListener(CloseEvent.CLOSE, 
					function():void
					{
						PopUpManager.removePopUp(window);
					});
				PopUpManager.addPopUp(window, this, true);
				PopUpManager.centerPopUp(window);
			}

		]]>
	</mx:Script>
	
	<header:HeaderCanvas id="headerCanvas"/>
	<mx:VDividedBox top="{headerCanvas.height}" bottom="0" liveDragging="true" right="50" left="50" >
		<mx:HDividedBox height="70%" width="100%" liveDragging="true" >
			<buddies:BuddyCanvas
				backgroundColor="0xffffff"
				id="buddyCanvas"
				width="25%"/>
			<messages:MessageCanvas
				backgroundColor="0xffffff"
				id="chatCanvas"
				width="75%"/>
		</mx:HDividedBox>
		<mx:TextArea
			id="console"
			backgroundColor="0xffffff"
			width="100%" height="200"
			text="{appModel.logText}"
			editable="false"
			updateComplete="console.verticalScrollPosition = console.maxVerticalScrollPosition"
			verticalScrollPolicy="on"
			includeInLayout="{appModel.showConsole}"
			visible="{appModel.showConsole}"
			/>
	</mx:VDividedBox>
	
</mx:Canvas>

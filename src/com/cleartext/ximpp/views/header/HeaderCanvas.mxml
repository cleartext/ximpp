<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml"
	width="100%" height="40"
	xmlns:common="com.cleartext.ximpp.views.common.*"
	creationComplete="init()">
	<mx:Script>
		<![CDATA[
			import com.cleartext.ximpp.events.BuddyEvent;
			import mx.binding.utils.ChangeWatcher;
			import mx.binding.utils.BindingUtils;
			import com.cleartext.ximpp.models.SettingsModel;
			import com.cleartext.ximpp.models.ApplicationModel;
			import com.cleartext.ximpp.models.valueObjects.Status;
			
			[Autowire]
			[Bindable]
			public var appModel:ApplicationModel;
			
			[Autowire]
			[Bindable]
			public var settings:SettingsModel;
			
			private function init():void
			{
				settings.addEventListener("userAccountChanged", userAccountChanged);
				userAccountChanged(null);
			}
			
			private function userAccountChanged(event:Event):void
			{
				if(settings.userAccount)
					settings.userAccount.removeEventListener(BuddyEvent.CHANGED, changeAvatar);

				if(settings.userAccount)
					settings.userAccount.addEventListener(BuddyEvent.CHANGED, changeAvatar);
				
				changeAvatar(null);
			}
			
			private function changeAvatar(event:BuddyEvent):void 
			{ 
				avatar.bitmapData = settings.userAccount.avatar; 
			}
			
			private function userPresenceChangeHandler():void
			{
				appModel.setUserPresence(statusComboBox.selectedLabel, customStatusInput.text);
			}
			
			override protected function updateDisplayList(unscaledWidth:Number, unscaledHeight:Number):void
			{
				super.updateDisplayList(unscaledWidth, unscaledHeight);
				
				var matr1:Matrix = new Matrix();
				matr1.createGradientBox(unscaledWidth, unscaledHeight, Math.PI/2, 0, 0);
				graphics.beginGradientFill(GradientType.LINEAR, [0x6ebfeb, 0x4d9ac4], [1, 1], [0x00, 0xFF], matr1);  
				graphics.drawRect(0, 0, unscaledWidth, unscaledHeight);
			}
			
		]]>
	</mx:Script>

	<common:Avatar
		id="avatar"
		width="37"
		height="37"
		x="15" y="1"
		/>
		
	<common:StatusIcon
		statusString="{appModel.serverSideStatus.value}"
		x="45" y="2"
		/>
	
	<mx:ComboBox
		id="statusComboBox"
		dataProvider="{Status.USER_TYPES}"
		change="userPresenceChangeHandler()"
		x="67" y="10" width="110"
		text="{appModel.serverSideStatus.value}"
		creationComplete="statusComboBox.text=appModel.serverSideStatus.value"
		/>
		
	<common:DefaultTextInput
		id="customStatusInput"
		valueCommit="userPresenceChangeHandler()"
		enter="userPresenceChangeHandler()"
		x="180" y="10" width="300"
		defaultText="custom status..."
		text="{settings.userAccount.customStatus}"
		/>

	<mx:Button
		label="{((appModel.showConsole) ? 'hide' : 'show' ) + ' console'}"
		click="appModel.showConsole = !appModel.showConsole"
		right="320" y="10" width="145"
		/>
	
	<mx:Button
		id="userPreferencesButton"
		label="User Preferences..."
		click="appModel.showPreferencesWindow()"
		right="165" y="10" width="145"
		/>

	<mx:Button
		id="advancedSearchButton"
		label="Advanced Search..."
		click="appModel.showAdvancedSearchWindow()"
		right="10" y="10" width="145"
		/>
</mx:Canvas>
